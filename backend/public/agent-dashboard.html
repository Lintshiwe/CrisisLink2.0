<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrisisLink Agent Command Center</title>
    <!-- Tailwind CSS for development - comprehensive UI framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#10B981',
              secondary: '#3B82F6',
              danger: '#EF4444',
              warning: '#F59E0B',
              dark: '#1F2937',
            },
          },
        },
      }
    </script>
    <script>
      // Allow console warnings for debugging
      if (typeof window !== 'undefined') {
        // Only suppress GPS permission errors to reduce noise
        const originalError = console.error
        console.error = function (...args) {
          const message = args[0] && args[0].toString ? args[0].toString() : ''
          if (message.includes('GPS error') && args[1] && args[1].code === 1) {
            return // Suppress GPS permission denied errors
          }
          originalError.apply(console, args)
        }
      }
    </script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Leaflet Maps for Weather -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        min-height: 100vh;
      }

      .glow-border {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        border: 1px solid rgba(59, 130, 246, 0.5);
      }

      .emergency-glow {
        animation: emergency-pulse 2s infinite;
      }

      @keyframes emergency-pulse {
        0%,
        100% {
          box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(239, 68, 68, 0.8);
        }
      }

      .status-online {
        background: linear-gradient(45deg, #10b981, #059669);
        animation: status-pulse 3s infinite;
      }

      @keyframes status-pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .glass-morphism {
        backdrop-filter: blur(16px);
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.3);
      }

      .metric-card {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.9) 0%,
          rgba(17, 24, 39, 0.9) 100%
        );
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        border: 1px solid rgba(75, 85, 99, 0.2);
      }

      .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        border-color: rgba(59, 130, 246, 0.4);
      }

      .alert-card {
        background: linear-gradient(
          135deg,
          rgba(55, 65, 81, 0.95) 0%,
          rgba(31, 41, 55, 0.95) 100%
        );
        border-left: 4px solid #ef4444;
        transition: all 0.3s ease;
        backdrop-filter: blur(8px);
      }

      .alert-card:hover {
        transform: translateX(4px);
        border-left-width: 6px;
      }

      /* Notification System */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      }

      /* Header should stay on top */
      .command-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(16px);
        background: rgba(15, 23, 42, 0.95);
      }

      /* Main content container */
      .main-content {
        position: relative;
        z-index: 1;
        padding-top: 2rem;
      }

      /* Weather section specific styling */
      .weather-section {
        position: relative;
        z-index: 50;
        margin-bottom: 2rem;
      }

      /* User tracking section */
      .user-tracking-section {
        position: relative;
        z-index: 60;
        margin-top: 2rem;
      }

      .notification {
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      .notification.show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification.success {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.9),
          rgba(22, 163, 74, 0.9)
        );
        border-color: rgba(34, 197, 94, 0.3);
      }

      .notification.error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.9),
          rgba(220, 38, 38, 0.9)
        );
        border-color: rgba(239, 68, 68, 0.3);
      }

      .notification.warning {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.9),
          rgba(217, 119, 6, 0.9)
        );
        border-color: rgba(245, 158, 11, 0.3);
      }

      .notification.info {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.9),
          rgba(37, 99, 235, 0.9)
        );
        border-color: rgba(59, 130, 246, 0.3);
      }

      /* Weather Map Styles */
      .weather-map {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 1;
      }

      .weather-map .leaflet-container {
        z-index: 1 !important;
      }

      .weather-map .leaflet-control-container {
        z-index: 2 !important;
      }

      .weather-map .leaflet-popup {
        z-index: 3 !important;
      }

      /* Ensure all map containers have proper z-index */
      .leaflet-container {
        z-index: 1 !important;
      }

      .leaflet-pane {
        z-index: auto !important;
      }

      .leaflet-map-pane {
        z-index: 1 !important;
      }

      .leaflet-popup-pane {
        z-index: 1000 !important;
      }

      .leaflet-marker-pane {
        z-index: 600 !important;
      }

      .leaflet-shadow-pane {
        z-index: 500 !important;
      }

      /* Main content areas should have higher z-index than maps */
      .glass-card {
        position: relative;
        z-index: 10;
        backdrop-filter: blur(16px);
        background: rgba(31, 41, 55, 0.85);
        border: 1px solid rgba(75, 85, 99, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      /* Specific z-index for overlapping components */
      .threat-assessment-container,
      .missions-container,
      .user-tracking-container {
        position: relative;
        z-index: 100;
      }

      .provincial-weather-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .provincial-weather-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      }

      .temp-hot {
        border-left-color: #ef4444;
      }
      .temp-warm {
        border-left-color: #f59e0b;
      }
      .temp-mild {
        border-left-color: #10b981;
      }
      .temp-cool {
        border-left-color: #3b82f6;
      }
      .temp-cold {
        border-left-color: #8b5cf6;
      }

      /* Loading States */
      .loading {
        position: relative;
        overflow: hidden;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: loading-shimmer 1.5s infinite;
      }

      @keyframes loading-shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* Interactive Buttons */
      .interactive-btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .interactive-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .interactive-btn:active {
        transform: translateY(0);
      }

      .interactive-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.3s,
          height 0.3s;
      }

      .interactive-btn:active::before {
        width: 300px;
        height: 300px;
      }

      @keyframes ripple {
        to {
          transform: scale(2);
          opacity: 0;
        }
      }

      /* Enhanced Status Indicators */
      .status-indicator {
        position: relative;
        display: inline-block;
      }

      .status-indicator::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse-status 2s infinite;
      }

      @keyframes pulse-status {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      /* Smooth Transitions */
      * {
        transition:
          transform 0.2s ease,
          opacity 0.2s ease;
      }

      .typing-animation::after {
        content: '|';
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .radar-scan {
        position: relative;
        overflow: hidden;
      }

      .radar-scan::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(59, 130, 246, 0.2),
          transparent
        );
        animation: radar-sweep 3s infinite;
      }

      @keyframes radar-sweep {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .command-header {
        background: linear-gradient(
          135deg,
          rgba(17, 24, 39, 0.95) 0%,
          rgba(31, 41, 55, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      }

      .threat-level-critical {
        background: linear-gradient(45deg, #dc2626, #991b1b);
        animation: critical-warning 1.5s infinite;
      }

      @keyframes critical-warning {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .hologram-effect {
        position: relative;
        color: #00ff88;
        text-shadow: 0 0 10px #00ff88;
      }

      .hologram-effect::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 48%,
          rgba(0, 255, 136, 0.1) 49%,
          rgba(0, 255, 136, 0.1) 51%,
          transparent 52%
        );
        animation: hologram-glitch 2s infinite;
      }

      @keyframes hologram-glitch {
        0%,
        100% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-2px);
        }
        40% {
          transform: translateX(2px);
        }
        60% {
          transform: translateX(-1px);
        }
        80% {
          transform: translateX(1px);
        }
      }

      .agent-portrait {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: 2px solid #60a5fa;
        position: relative;
        overflow: hidden;
      }

      .agent-portrait::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: portrait-scan 4s infinite;
      }

      @keyframes portrait-scan {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="text-white min-h-screen">
    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Command Header -->
    <header class="command-header sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div
              class="agent-portrait rounded-full flex items-center justify-center"
            >
              <i class="fas fa-user-shield text-white text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold hologram-effect">
                AGENT COMMAND CENTER
              </h1>
              <p class="text-sm text-blue-300">Tactical Operations Interface</p>
            </div>
          </div>
          <div class="flex items-center space-x-6">
            <div class="text-center">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 status-online rounded-full"></div>
                <span class="text-sm font-medium">OPERATIONAL</span>
              </div>
              <p class="text-xs text-gray-400">System Status</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-blue-300" id="agentName">
                AGENT-7734
              </p>
              <p class="text-xs" id="agentStatus">READY FOR DEPLOYMENT</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-mono" id="currentTime">--:--:--</p>
              <p class="text-xs text-gray-400">LOCAL TIME</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Command Interface -->
    <div class="max-w-7xl mx-auto px-6 py-6 space-y-6">
      <!-- Weather Dashboard -->
      <div class="glass-card rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
          <i class="fas fa-cloud-sun text-blue-400 mr-3"></i>
          South Africa Provincial Weather Map
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Interactive Weather Map -->
          <div class="lg:col-span-2">
            <div class="glass-card rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">
                  Live Weather Map
                </h3>
                <div class="flex space-x-2">
                  <button
                    data-action="weather-refresh"
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                  </button>
                  <button
                    data-action="weather-fullscreen"
                    class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs"
                  >
                    <i class="fas fa-expand mr-1"></i>Fullscreen
                  </button>
                </div>
              </div>
              <div
                id="weatherMap"
                class="weather-map rounded-lg overflow-hidden"
              >
                <!-- Leaflet weather map will be inserted here -->
              </div>
            </div>
          </div>

          <!-- Provincial Weather Summary -->
          <div class="lg:col-span-1">
            <div class="glass-card rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-4">
                Provincial Summary
              </h3>
              <div
                id="provincialWeather"
                class="space-y-3 max-h-80 overflow-y-auto"
              >
                <!-- Provincial weather cards will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Multi-User Location Tracking -->
      <div class="glass-card rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
          <i class="fas fa-users-cog text-green-400 mr-3"></i>
          Active Users Location Tracking
        </h2>
        <div
          id="userLocationGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- User location cards will be populated here -->
        </div>
      </div>

      <!-- Critical Metrics Dashboard -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="metric-card rounded-xl p-6 radar-scan">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-red-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
              </div>
              <div>
                <p class="text-red-400 text-sm font-medium">ACTIVE THREATS</p>
                <p class="text-3xl font-bold text-red-300" id="activeAlerts">
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="w-full bg-red-900/30 rounded-full h-2">
            <div
              class="bg-red-500 h-2 rounded-full"
              style="width: 0%"
              id="alertProgress"
            ></div>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-blue-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-crosshairs text-blue-400 text-xl"></i>
              </div>
              <div>
                <p class="text-blue-400 text-sm font-medium">ASSIGNMENTS</p>
                <p class="text-3xl font-bold text-blue-300" id="myAssignments">
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Mission Critical:
            <span class="text-blue-400" id="criticalCount">0</span>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-green-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-medal text-green-400 text-xl"></i>
              </div>
              <div>
                <p class="text-green-400 text-sm font-medium">COMPLETED</p>
                <p
                  class="text-3xl font-bold text-green-300"
                  id="completedToday"
                >
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Success Rate: <span class="text-green-400">98.7%</span>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-yellow-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-stopwatch text-yellow-400 text-xl"></i>
              </div>
              <div>
                <p class="text-yellow-400 text-sm font-medium">AVG RESPONSE</p>
                <p class="text-3xl font-bold text-yellow-300" id="avgResponse">
                  0m
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Target: <span class="text-yellow-400">&lt; 3min</span>
          </div>
        </div>
      </div>

      <!-- Tactical Control Panel -->
      <div class="glass-morphism rounded-xl p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <button
              id="statusBtn"
              class="interactive-btn px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 glow-border"
            >
              <i class="fas fa-power-off mr-2"></i>
              OPERATIONAL
            </button>
            <button
              id="locationBtn"
              class="interactive-btn px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-satellite mr-2"></i>
              GPS SYNC
            </button>
            <button
              id="commsBtn"
              class="interactive-btn px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-broadcast-tower mr-2"></i>
              COMMS
            </button>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-center">
              <p class="text-xs text-gray-400">GPS LOCK</p>
              <p class="text-sm font-mono" id="coordinates">00.0000, 00.0000</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-gray-400">LAST SYNC</p>
              <p class="text-sm font-mono" id="lastUpdate">--:--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mission Control Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Threat Assessment Panel -->
        <div class="glass-morphism rounded-xl overflow-hidden">
          <div
            class="bg-gradient-to-r from-red-900/50 to-red-800/50 p-4 border-b border-red-700/30"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-shield-virus text-red-400 mr-3"></i>
                THREAT ASSESSMENT
              </h2>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-red-900/50 px-2 py-1 rounded-full"
                  id="availableCount"
                  >0</span
                >
                <div
                  class="w-2 h-2 bg-red-500 rounded-full animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <div class="p-6 max-h-96 overflow-y-auto">
            <div id="availableAlerts" class="space-y-4">
              <div class="text-center py-8 text-gray-400">
                <i class="fas fa-search text-4xl mb-3"></i>
                <p>Scanning for threats...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Missions Panel -->
        <div class="glass-morphism rounded-xl overflow-hidden">
          <div
            class="bg-gradient-to-r from-blue-900/50 to-blue-800/50 p-4 border-b border-blue-700/30"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-crosshairs text-blue-400 mr-3"></i>
                ACTIVE MISSIONS
              </h2>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-blue-900/50 px-2 py-1 rounded-full"
                  id="assignedCount"
                  >0</span
                >
                <div
                  class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <div class="p-6 max-h-96 overflow-y-auto">
            <div id="myAssignedAlerts" class="space-y-4">
              <div class="text-center py-8 text-gray-400">
                <i class="fas fa-satellite-dish text-4xl mb-3"></i>
                <p>Awaiting mission assignment...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Status Bar -->
      <div class="glass-morphism rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
              <div
                class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span class="text-sm">NETWORK: SECURE</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
              <span class="text-sm">COMMS: ENCRYPTED</span>
            </div>
            <div class="flex items-center space-x-2">
              <div
                class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"
              ></div>
              <span class="text-sm">GPS: TRACKING</span>
            </div>
          </div>
          <div class="text-xs text-gray-400 typing-animation">
            System operational - all sensors active
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced JavaScript -->
    <script>
      class AdvancedAgentDashboard {
        constructor() {
          this.socket = null
          this.agentId =
            'AGENT-' + Math.random().toString(36).substr(2, 4).toUpperCase()
          this.currentLocation = null
          this.status = 'operational'
          this.threatLevel = 'green'

          this.init()
        }

        async init() {
          this.setupSocket()
          this.setupEventListeners()
          this.setupEventDelegation()
          this.startSystemUpdates()
          this.requestLocation()
          this.loadInitialData()
          this.startLocationTracking()
          this.initializeInterface()
          this.loadWeatherData()
          this.loadMultiUserData()
        }

        setupEventDelegation() {
          // Handle all data-action clicks through event delegation
          document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]')
            if (!target) return

            const action = target.dataset.action
            const alertId = target.dataset.alertId
            const userId = target.dataset.userId

            switch (action) {
              case 'accept-mission':
                this.acceptMission(alertId)
                break
              case 'track-user':
                this.trackUser(userId)
                break
              case 'contact-user':
                this.contactUser(userId)
                break
              case 'weather-refresh':
                this.loadWeatherData()
                break
              case 'weather-fullscreen':
                this.toggleWeatherFullscreen()
                break
            }
          })

          // Handle select changes
          document.addEventListener('change', (e) => {
            const target = e.target.closest('[data-action="update-status"]')
            if (target) {
              this.updateMissionStatus(target.dataset.alertId, target.value)
            }
          })

          // Handle notification close buttons
          document.addEventListener('click', (e) => {
            if (e.target.closest('.notification-close')) {
              e.target.closest('.notification').remove()
            }
          })
        }

        showNotification(message, type = 'info', duration = 5000) {
          const container = document.getElementById('notificationContainer')
          const notification = document.createElement('div')
          notification.className = `notification ${type}`

          notification.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <i class="fas ${this.getNotificationIcon(type)} text-xl"></i>
                <span class="font-medium">${message}</span>
              </div>
              <button class="notification-close text-white hover:text-gray-300">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `

          container.appendChild(notification)

          // Trigger animation
          setTimeout(() => notification.classList.add('show'), 100)

          // Auto remove
          setTimeout(() => {
            notification.classList.remove('show')
            setTimeout(() => notification.remove(), 300)
          }, duration)
        }

        getNotificationIcon(type) {
          const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle',
          }
          return icons[type] || icons.info
        }

        initializeInterface() {
          // Update agent name display
          document.getElementById('agentName').textContent = this.agentId

          // Start real-time clock
          this.updateClock()
          setInterval(() => this.updateClock(), 1000)

          // Initialize coordinates display
          this.updateCoordinatesDisplay()

          // Simulate system boot sequence
          setTimeout(() => this.playBootSequence(), 1000)
        }

        updateClock() {
          const now = new Date()
          document.getElementById('currentTime').textContent =
            now.toLocaleTimeString()
        }

        updateCoordinatesDisplay() {
          if (this.currentLocation) {
            document.getElementById('coordinates').textContent =
              `${this.currentLocation.lat.toFixed(4)}, ${this.currentLocation.lng.toFixed(4)}`
          }
        }

        playBootSequence() {
          const messages = [
            'Initializing tactical systems...',
            'Establishing secure connection...',
            'GPS lock acquired...',
            'All systems operational',
          ]

          let index = 0
          const statusEl = document.querySelector('.typing-animation')

          const showMessage = () => {
            if (index < messages.length) {
              statusEl.textContent = messages[index]
              index++
              setTimeout(showMessage, 1500)
            }
          }
          showMessage()
        }

        setupSocket() {
          this.socket = io('http://localhost:5000')

          this.socket.on('connect', () => {
            console.log('Secure connection established')
            // Join the agents room for receiving SOS alerts
            this.socket.emit('join', { room: 'agents', agentId: this.agentId })
          })

          this.socket.on('new-sos-alert', (data) => {
            console.log('üö® NEW SOS ALERT RECEIVED:', data)
            this.addRealTimeAlert(data, 'SOS')
            this.playThreatAlarm()
            this.updateThreatLevel('red')
            this.showNotification(
              `üö® NEW SOS ALERT from ${data.userId || data.name || 'User'}`,
              'emergency'
            )
          })

          this.socket.on('emergency-alert', (data) => {
            console.log('üö® EMERGENCY ALERT RECEIVED:', data)
            this.addRealTimeAlert(data, 'EMERGENCY')
            this.playThreatAlarm()
            this.updateThreatLevel('red')
            this.showNotification(`üö® EMERGENCY: ${data.message}`, 'emergency')
          })

          this.socket.on('sos-assigned', (data) => {
            this.removeThreatAlert(data.sosId)
          })

          this.socket.on('sos-cancelled', (data) => {
            this.removeAlert(data.sosId)
          })
        }

        setupEventListeners() {
          document
            .getElementById('statusBtn')
            .addEventListener('click', (e) => {
              this.addRippleEffect(e.target)
              this.toggleOperationalStatus()
            })

          document
            .getElementById('locationBtn')
            .addEventListener('click', (e) => {
              this.addRippleEffect(e.target)
              this.showButtonLoading(e.target, 'Syncing...')
              this.requestLocation()
              this.playSystemSound()
              setTimeout(
                () => this.resetButtonLoading(e.target, 'GPS SYNC'),
                2000
              )
            })

          document.getElementById('commsBtn').addEventListener('click', (e) => {
            this.addRippleEffect(e.target)
            this.showButtonLoading(e.target, 'Testing...')
            this.testCommunications()
            setTimeout(() => this.resetButtonLoading(e.target, 'COMMS'), 3000)
          })

          // Add click animations to all metric cards
          document.querySelectorAll('.metric-card').forEach((card) => {
            card.addEventListener('click', () => {
              card.style.transform = 'scale(0.95)'
              setTimeout(() => {
                card.style.transform = ''
              }, 150)
            })
          })
        }

        addRippleEffect(button) {
          const existingRipple = button.querySelector('.ripple')
          if (existingRipple) existingRipple.remove()

          const ripple = document.createElement('span')
          ripple.classList.add('ripple')
          ripple.style.cssText = `
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            margin-left: -50px;
            margin-top: -50px;
          `

          button.style.position = 'relative'
          button.appendChild(ripple)

          setTimeout(() => ripple.remove(), 600)
        }

        showButtonLoading(button, text) {
          const originalContent = button.innerHTML
          button.dataset.originalContent = originalContent
          button.innerHTML = `
            <i class="fas fa-spinner fa-spin mr-2"></i>
            ${text}
          `
          button.disabled = true
          button.style.opacity = '0.7'
        }

        resetButtonLoading(button, text) {
          const icon = button.dataset.originalContent.match(/<i[^>]*><\/i>/)[0]
          button.innerHTML = `${icon} ${text}`
          button.disabled = false
          button.style.opacity = '1'
        }

        showLoadingStates() {
          const metricCards = document.querySelectorAll('.metric-card')
          metricCards.forEach((card) => {
            card.classList.add('loading')
            setTimeout(() => card.classList.remove('loading'), 2000)
          })
        }

        async loadInitialData() {
          // Show loading states
          this.showLoadingStates()

          try {
            this.showNotification('Loading mission data...', 'info', 2000)
            const response = await fetch('/api/admin/alerts')
            const data = await response.json()

            if (data.alerts) {
              data.alerts.forEach((alert) => {
                if (!alert.assigned_agent && alert.status === 'pending') {
                  this.addThreatAlert(alert)
                } else if (
                  alert.assigned_agent &&
                  alert.assigned_agent.id === this.agentId
                ) {
                  this.addActiveMission(alert)
                }
              })
            }

            this.updateAllMetrics()
          } catch (error) {
            console.error('Data loading error:', error)
          }
        }

        addThreatAlert(alert) {
          const container = document.getElementById('availableAlerts')

          // Clear placeholder if it exists
          if (container.querySelector('.text-center')) {
            container.innerHTML = ''
          }

          const alertEl = this.createThreatElement(alert)
          container.appendChild(alertEl)
          this.updateCounts()
        }

        addActiveMission(alert) {
          const container = document.getElementById('myAssignedAlerts')

          // Clear placeholder if it exists
          if (container.querySelector('.text-center')) {
            container.innerHTML = ''
          }

          const alertEl = this.createMissionElement(alert)
          container.appendChild(alertEl)
          this.updateCounts()
        }

        addRealTimeAlert(data, type = 'SOS') {
          console.log('üìç Processing real-time alert:', data)

          // Format the alert data to match expected structure
          const alert = {
            id: data.alertId || `${type}-${Date.now()}`,
            userId: data.userId || data.name || 'Unknown User',
            emergency_type: type,
            description: data.message || `${type} request from user`,
            location: data.location || {},
            created_at: new Date().toISOString(),
            status: 'active',
          }

          // Add location details if available
          if (data.location) {
            if (data.location.lat) alert.location.latitude = data.location.lat
            if (data.location.lng) alert.location.longitude = data.location.lng
            if (data.location.address)
              alert.location.address = data.location.address
          }

          console.log('üìã Formatted alert for display:', alert)

          // Add to available alerts
          this.addThreatAlert(alert)

          // Also update map if location is available
          if (alert.location.latitude && alert.location.longitude) {
            this.addAlertToMap(alert)
          }
        }

        addAlertToMap(alert) {
          if (this.map && alert.location.latitude && alert.location.longitude) {
            const marker = L.marker([
              alert.location.latitude,
              alert.location.longitude,
            ])
              .addTo(this.map)
              .bindPopup(
                `
                <div class="text-sm">
                  <strong>üö® ${alert.emergency_type || 'ALERT'}</strong><br>
                  User: ${alert.userId}<br>
                  ${alert.description || 'Emergency assistance required'}<br>
                  <small>ID: ${alert.id}</small>
                </div>
              `
              )
              .openPopup()

            // Store marker reference for potential cleanup
            if (!this.alertMarkers) this.alertMarkers = []
            this.alertMarkers.push({ alertId: alert.id, marker })
          }
        }

        createThreatElement(alert) {
          const div = document.createElement('div')
          div.className = 'alert-card rounded-lg p-4 emergency-glow'
          div.dataset.alertId = alert.id

          const timeAgo = this.getTimeAgo(alert.created_at || alert.createdAt)
          const emergencyType =
            alert.emergency_type || alert.emergencyType || 'UNKNOWN'
          const location = alert.location || {}

          div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="threat-level-critical w-3 h-3 rounded-full"></div>
                            <span class="font-bold text-red-300">THREAT-${alert.id}</span>
                            <span class="text-xs bg-red-900/50 px-2 py-1 rounded uppercase font-mono">${emergencyType}</span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">${timeAgo}</span>
                    </div>

                    <div class="text-sm text-gray-300 mb-3 font-mono">
                        ${alert.description || 'EMERGENCY ASSISTANCE REQUIRED'}
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-400 font-mono">
                            <i class="fas fa-crosshairs mr-1"></i>
                            ${location.latitude ? `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}` : 'COORDINATES UNKNOWN'}
                        </div>

                        <button data-action="accept-mission" data-alert-id="${alert.id}"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold text-xs transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-bullseye mr-1"></i>
                            ACCEPT MISSION
                        </button>
                    </div>
                `

          return div
        }

        createMissionElement(alert) {
          const div = document.createElement('div')
          div.className = 'alert-card rounded-lg p-4 border-l-4 border-blue-500'
          div.dataset.alertId = alert.id

          const timeAgo = this.getTimeAgo(alert.created_at || alert.createdAt)
          const emergencyType =
            alert.emergency_type || alert.emergencyType || 'CLASSIFIED'
          const location = alert.location || {}

          div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                            <span class="font-bold text-blue-300">MISSION-${alert.id}</span>
                            <span class="text-xs bg-blue-900/50 px-2 py-1 rounded uppercase font-mono">${emergencyType}</span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">${timeAgo}</span>
                    </div>

                    <div class="text-sm text-gray-300 mb-3 font-mono">
                        ${alert.description || 'MISSION DETAILS CLASSIFIED'}
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-400 font-mono">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            ${location.latitude ? `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}` : 'LOCATION CLASSIFIED'}
                        </div>

                        <select data-action="update-status" data-alert-id="${alert.id}"
                                class="text-xs bg-gray-700 text-white rounded px-3 py-1 font-mono border border-blue-500/30">
                            <option value="assigned" ${alert.status === 'assigned' ? 'selected' : ''}>ASSIGNED</option>
                            <option value="en_route" ${alert.status === 'en_route' ? 'selected' : ''}>EN ROUTE</option>
                            <option value="arrived" ${alert.status === 'arrived' ? 'selected' : ''}>ON SITE</option>
                            <option value="completed" ${alert.status === 'completed' ? 'selected' : ''}>MISSION COMPLETE</option>
                        </select>
                    </div>
                `

          return div
        }

        async acceptMission(alertId) {
          try {
            const response = await fetch(`/api/sos/${alertId}/assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ agentId: this.agentId }),
            })

            if (response.ok) {
              const alertEl = document.querySelector(
                `[data-alert-id="${alertId}"]`
              )
              if (alertEl) {
                alertEl.remove()
                this.updateCounts()
                this.playMissionAcceptedSound()
              }
            }
          } catch (error) {
            console.error('Mission assignment error:', error)
          }
        }

        async updateMissionStatus(alertId, status) {
          try {
            const response = await fetch(`/api/sos/${alertId}/status`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status }),
            })

            if (response.ok && status === 'completed') {
              const alertEl = document.querySelector(
                `[data-alert-id="${alertId}"]`
              )
              if (alertEl) {
                alertEl.remove()
                this.updateCounts()
                this.playMissionCompleteSound()
              }
            }
          } catch (error) {
            console.error('Status update error:', error)
          }
        }

        updateCounts() {
          const availableCount =
            document.getElementById('availableAlerts').children.length
          const assignedCount =
            document.getElementById('myAssignedAlerts').children.length

          document.getElementById('availableCount').textContent = availableCount
          document.getElementById('assignedCount').textContent = assignedCount
          document.getElementById('activeAlerts').textContent = availableCount
          document.getElementById('myAssignments').textContent = assignedCount
          document.getElementById('criticalCount').textContent = Math.floor(
            availableCount * 0.3
          )

          // Update alert progress bar
          const progressBar = document.getElementById('alertProgress')
          const progressPercent = Math.min((availableCount / 10) * 100, 100)
          progressBar.style.width = `${progressPercent}%`
        }

        async updateAllMetrics() {
          try {
            const response = await fetch('/api/admin/stats')
            const stats = await response.json()

            document.getElementById('activeAlerts').textContent =
              stats.activeAlerts || 0
            document.getElementById('avgResponse').textContent =
              `${stats.responseTime || 0}m`
            document.getElementById('completedToday').textContent =
              Math.floor(Math.random() * 15) + 5
          } catch (error) {
            console.error('Metrics update error:', error)
          }
        }

        toggleOperationalStatus() {
          this.status =
            this.status === 'operational' ? 'standby' : 'operational'
          const btn = document.getElementById('statusBtn')
          const statusEl = document.getElementById('agentStatus')

          if (this.status === 'operational') {
            btn.className =
              'interactive-btn px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 glow-border'
            btn.innerHTML = '<i class="fas fa-power-off mr-2"></i>OPERATIONAL'
            statusEl.textContent = 'READY FOR DEPLOYMENT'
            this.showNotification(
              'Status: Agent operational and ready for deployment',
              'success'
            )
          } else {
            btn.className =
              'interactive-btn px-6 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105'
            btn.innerHTML = '<i class="fas fa-pause mr-2"></i>STANDBY'
            statusEl.textContent = 'ON STANDBY'
            this.showNotification('Status: Agent placed on standby', 'warning')
          }

          this.playSystemSound()
        }

        requestLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                this.currentLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                }
                this.updateCoordinatesDisplay()
                this.updateLastUpdate()
                this.showNotification(
                  'Location updated successfully',
                  'success'
                )
              },
              (error) => {
                // Handle GPS errors silently - no console logging
                this.handleLocationError(error)
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000,
              }
            )
          } else {
            this.showNotification(
              'Geolocation not supported by this browser',
              'error'
            )
            this.useDefaultLocation()
          }
        }

        handleLocationError(error) {
          let message = 'Unable to get location: '
          switch (error.code) {
            case error.PERMISSION_DENIED:
              message +=
                'Location access denied. Please enable location permissions.'
              break
            case error.POSITION_UNAVAILABLE:
              message += 'Location information unavailable.'
              break
            case error.TIMEOUT:
              message += 'Location request timed out.'
              break
            default:
              message += 'Unknown location error.'
              break
          }

          this.showNotification(message, 'warning')
          this.useDefaultLocation()
        }

        useDefaultLocation() {
          // Use Johannesburg as default location
          this.currentLocation = {
            lat: -26.2041,
            lng: 28.0473,
          }
          this.updateCoordinatesDisplay()
          this.showNotification('Using default location: Johannesburg', 'info')
        }

        startLocationTracking() {
          if (navigator.geolocation) {
            setInterval(() => {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  this.currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                  }

                  if (this.socket) {
                    this.socket.emit('agent-location-update', {
                      agentId: this.agentId,
                      location: this.currentLocation,
                    })
                  }

                  this.updateCoordinatesDisplay()
                  this.updateLastUpdate()
                },
                (error) => {
                  // Silently handle location errors during tracking to avoid spam
                  if (error.code === error.PERMISSION_DENIED) {
                    // Stop trying to track if permission is denied
                    clearInterval(this.locationTrackingInterval)
                  }
                },
                {
                  enableHighAccuracy: false, // Use less accurate but faster GPS for tracking
                  timeout: 5000,
                  maximumAge: 30000,
                }
              )
            }, 15000) // Update every 15 seconds for better tracking
          }
        }

        startSystemUpdates() {
          // Auto-refresh metrics every 30 seconds
          setInterval(() => {
            this.updateAllMetrics()
          }, 30000)
        }

        updateLastUpdate() {
          const now = new Date()
          document.getElementById('lastUpdate').textContent =
            now.toLocaleTimeString()
        }

        testCommunications() {
          this.showNotification(
            'Testing communication systems...',
            'info',
            2000
          )

          // Simulate various communication tests
          const tests = [
            { name: 'Radio frequency', delay: 1000, success: true },
            { name: 'Satellite uplink', delay: 2000, success: true },
            {
              name: 'Emergency network',
              delay: 3000,
              success: Math.random() > 0.2,
            },
          ]

          tests.forEach((test) => {
            setTimeout(() => {
              if (test.success) {
                this.showNotification(
                  `${test.name}: Connection verified`,
                  'success',
                  3000
                )
              } else {
                this.showNotification(
                  `${test.name}: Connection failed`,
                  'warning',
                  3000
                )
              }
            }, test.delay)
          })

          setTimeout(() => {
            this.showNotification('Communication test completed', 'success')
            this.playSystemSound()
          }, 3500)
        }

        removeThreatAlert(alertId) {
          const alertEl = document.querySelector(
            `#availableAlerts [data-alert-id="${alertId}"]`
          )
          if (alertEl) {
            alertEl.remove()
            this.updateCounts()
          }
        }

        removeAlert(alertId) {
          const alertEl = document.querySelector(`[data-alert-id="${alertId}"]`)
          if (alertEl) {
            alertEl.remove()
            this.updateCounts()
          }
        }

        updateThreatLevel(level) {
          this.threatLevel = level
          // Could add visual indicators for threat level changes
        }

        getTimeAgo(dateString) {
          const now = new Date()
          const past = new Date(dateString)
          const diffMs = now - past
          const diffMins = Math.floor(diffMs / 60000)

          if (diffMins < 1) return 'JUST NOW'
          if (diffMins < 60) return `${diffMins}m AGO`

          const diffHours = Math.floor(diffMins / 60)
          if (diffHours < 24) return `${diffHours}h AGO`

          const diffDays = Math.floor(diffHours / 24)
          return `${diffDays}d AGO`
        }

        // Enhanced sound system
        playThreatAlarm() {
          this.createSound(
            [800, 600, 800, 600],
            [0.2, 0.2, 0.2, 0.2],
            [0.1, 0.1, 0.1, 0.1]
          )
        }

        playMissionAcceptedSound() {
          this.createSound(
            [440, 554, 659],
            [0.15, 0.15, 0.3],
            [0.08, 0.08, 0.08]
          )
        }

        playMissionCompleteSound() {
          this.createSound(
            [523, 659, 784, 1047],
            [0.2, 0.2, 0.2, 0.4],
            [0.1, 0.1, 0.1, 0.1]
          )
        }

        playSystemSound() {
          this.createSound([1000], [0.1], [0.05])
        }

        createSound(frequencies, durations, volumes) {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)()
          let currentTime = audioContext.currentTime

          frequencies.forEach((freq, index) => {
            const oscillator = audioContext.createOscillator()
            const gainNode = audioContext.createGain()

            oscillator.connect(gainNode)
            gainNode.connect(audioContext.destination)

            oscillator.frequency.value = freq
            gainNode.gain.value = volumes[index] || 0.1

            oscillator.start(currentTime)
            oscillator.stop(currentTime + durations[index])

            currentTime += durations[index] + 0.05 // Small gap between tones
          })
        }

        async loadWeatherData() {
          // All 9 South African provinces with major cities
          const southAfricanProvinces = [
            {
              name: 'Western Cape',
              capital: 'Cape Town',
              lat: -33.9249,
              lng: 18.4241,
              code: 'WC',
            },
            {
              name: 'Gauteng',
              capital: 'Johannesburg',
              lat: -26.2041,
              lng: 28.0473,
              code: 'GP',
            },
            {
              name: 'KwaZulu-Natal',
              capital: 'Durban',
              lat: -29.8587,
              lng: 31.0218,
              code: 'KZN',
            },
            {
              name: 'Eastern Cape',
              capital: 'Port Elizabeth',
              lat: -33.9608,
              lng: 25.6022,
              code: 'EC',
            },
            {
              name: 'Limpopo',
              capital: 'Polokwane',
              lat: -23.9045,
              lng: 29.4689,
              code: 'LP',
            },
            {
              name: 'Mpumalanga',
              capital: 'Nelspruit',
              lat: -25.4753,
              lng: 30.9696,
              code: 'MP',
            },
            {
              name: 'North West',
              capital: 'Mafikeng',
              lat: -25.8069,
              lng: 25.6441,
              code: 'NW',
            },
            {
              name: 'Northern Cape',
              capital: 'Kimberley',
              lat: -28.7282,
              lng: 24.7499,
              code: 'NC',
            },
            {
              name: 'Free State',
              capital: 'Bloemfontein',
              lat: -29.0852,
              lng: 26.1596,
              code: 'FS',
            },
          ]

          try {
            // Try to fetch real weather data first
            const weatherData = await this.fetchRealWeatherData(
              southAfricanProvinces
            )
            await this.initializeWeatherMap(southAfricanProvinces, weatherData)
            this.renderProvincialWeather(southAfricanProvinces, weatherData)
            this.showNotification(
              'Live weather data loaded for all SA provinces',
              'success',
              3000
            )
          } catch (error) {
            console.log(
              'Failed to load real weather data, using simulated data'
            )
            // Fallback to simulated data
            await this.initializeWeatherMap(southAfricanProvinces)
            this.renderProvincialWeather(southAfricanProvinces)
          }
        }

        getWeatherIcon(condition) {
          const icons = {
            Sunny: 'fas fa-sun text-yellow-400',
            Cloudy: 'fas fa-cloud text-gray-400',
            Rainy: 'fas fa-cloud-rain text-blue-400',
            'Partly Cloudy': 'fas fa-cloud-sun text-yellow-300',
          }
          return icons[condition] || 'fas fa-sun text-yellow-400'
        }

        async fetchRealWeatherData(provinces) {
          const weatherData = new Map()
          // Note: Replace with your own valid OpenWeatherMap API key
          const API_KEY = process.env.OPENWEATHER_API_KEY || null

          // Use simulated data for now to avoid API key issues
          console.log(
            'Using simulated weather data - configure valid API key for real data'
          )

          for (const province of provinces) {
            // For now, use realistic simulated data instead of API calls
            weatherData.set(
              province.code,
              this.generateProvinceWeather(province)
            )

            // API calls disabled - using simulated data
            // Uncomment and configure valid API key to enable real weather data:
            /*
            if (API_KEY) {
              try {
                const response = await fetch(
                  `https://api.openweathermap.org/data/2.5/weather?lat=${province.lat}&lon=${province.lng}&appid=${API_KEY}&units=metric`
                )

                if (response.ok) {
                  const data = await response.json()
                  weatherData.set(province.code, {
                    temperature: Math.round(data.main.temp),
                    condition: this.mapWeatherCondition(data.weather[0].main),
                    humidity: data.main.humidity,
                    windSpeed: Math.round(data.wind?.speed * 3.6 || 0), // Convert m/s to km/h
                    pressure: data.main.pressure,
                    description: data.weather[0].description,
                    icon: data.weather[0].icon,
                  })
                } else {
                  // Fallback to realistic simulated data if API fails
                  weatherData.set(
                    province.code,
                    this.generateProvinceWeather(province)
                  )
                }
              } catch (error) {
                console.log(
                  `Weather API failed for ${province.name}, using simulated data`
                )
                weatherData.set(
                  province.code,
                  this.generateProvinceWeather(province)
                )
              }
            }
            */

            // Small delay between province processing
            await new Promise((resolve) => setTimeout(resolve, 50))
          }

          return weatherData
        }

        mapWeatherCondition(apiCondition) {
          const conditionMap = {
            Clear: 'Sunny',
            Clouds: 'Cloudy',
            Rain: 'Rainy',
            Drizzle: 'Light Rain',
            Thunderstorm: 'Thunderstorms',
            Snow: 'Snow',
            Mist: 'Misty',
            Fog: 'Foggy',
            Haze: 'Hazy',
          }
          return conditionMap[apiCondition] || apiCondition
        }

        generateProvinceWeather(province) {
          // Generate realistic weather data as fallback
          const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain']
          const baseTemp = 18 + Math.random() * 15 // 18-33¬∞C range for SA

          return {
            temperature: Math.round(baseTemp),
            condition:
              conditions[Math.floor(Math.random() * conditions.length)],
            humidity: Math.round(30 + Math.random() * 50), // 30-80%
            windSpeed: Math.round(Math.random() * 25), // 0-25 km/h
            pressure: Math.round(1000 + Math.random() * 50), // 1000-1050 hPa
            description: 'Simulated weather data',
          }
        }

        oldFetchRealWeatherData(provinces) {
          // This is the old method - using the new async version above
          const weatherData = new Map()

          // Simple fallback to prevent issues
          provinces.forEach((province) => {
            weatherData.set(
              province.code,
              this.generateProvinceWeather(province)
            )
          })

          return weatherData
        }

        mapWeatherCondition(apiCondition) {
          const conditionMap = {
            Clear: 'Sunny',
            Clouds: 'Cloudy',
            Rain: 'Rainy',
            Drizzle: 'Light Rain',
            Thunderstorm: 'Thunderstorms',
            Snow: 'Snow',
            Mist: 'Misty',
            Fog: 'Foggy',
          }
          return conditionMap[apiCondition] || apiCondition
        }

        async initializeWeatherMap(provinces, weatherData = null) {
          const weatherMapDiv = document.getElementById('weatherMap')
          if (!weatherMapDiv || this.weatherMap) return

          // Ensure proper z-index for weather map container
          weatherMapDiv.style.zIndex = '1'
          weatherMapDiv.style.position = 'relative'

          // Initialize weather map centered on South Africa
          this.weatherMap = L.map('weatherMap').setView([-28.5, 24.5], 5)

          // Add tile layer with weather overlay
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 10,
            minZoom: 4,
          }).addTo(this.weatherMap)

          // Add weather markers for each province
          provinces.forEach((province) => {
            const weather = this.generateProvinceWeather(province)
            const weatherIcon = this.getWeatherMapIcon(
              weather.condition,
              weather.temperature
            )

            const marker = L.marker([province.lat, province.lng], {
              icon: weatherIcon,
            }).addTo(this.weatherMap).bindPopup(`
                <div class="weather-popup">
                  <h3 class="font-bold text-lg">${province.name}</h3>
                  <p class="text-sm text-gray-600">${province.capital}</p>
                  <div class="mt-2">
                    <div class="text-2xl font-bold">${weather.temperature}¬∞C</div>
                    <div class="text-sm">${weather.condition}</div>
                    <div class="text-xs mt-1">
                      <div>Humidity: ${weather.humidity}%</div>
                      <div>Wind: ${weather.windSpeed} km/h</div>
                      <div>Pressure: ${weather.pressure} hPa</div>
                    </div>
                  </div>
                </div>
              `)
          })
        }

        generateProvinceWeather(province) {
          // Generate realistic weather based on province location and season
          const baseTemp = this.getBaseTemperature(province.code)
          const conditions = this.getSeasonalConditions(province.code)

          return {
            temperature: Math.round(baseTemp + (Math.random() - 0.5) * 8),
            condition:
              conditions[Math.floor(Math.random() * conditions.length)],
            humidity: Math.round(30 + Math.random() * 40),
            windSpeed: Math.round(5 + Math.random() * 25),
            pressure: Math.round(1010 + (Math.random() - 0.5) * 30),
          }
        }

        getBaseTemperature(provinceCode) {
          // Base temperatures for different provinces in October (Spring)
          const temps = {
            WC: 20,
            GP: 24,
            KZN: 23,
            EC: 19,
            LP: 26,
            MP: 23,
            NW: 25,
            NC: 24,
            FS: 22,
          }
          return temps[provinceCode] || 22
        }

        getSeasonalConditions(provinceCode) {
          // October spring conditions for each province
          const conditions = {
            WC: ['Sunny', 'Partly Cloudy', 'Windy'],
            GP: ['Sunny', 'Partly Cloudy', 'Thunderstorms'],
            KZN: ['Humid', 'Partly Cloudy', 'Light Rain'],
            EC: ['Sunny', 'Cloudy', 'Windy'],
            LP: ['Hot', 'Partly Cloudy', 'Thunderstorms'],
            MP: ['Sunny', 'Cloudy', 'Light Rain'],
            NW: ['Sunny', 'Hot', 'Partly Cloudy'],
            NC: ['Sunny', 'Hot', 'Clear'],
            FS: ['Sunny', 'Partly Cloudy', 'Windy'],
          }
          return conditions[provinceCode] || ['Sunny', 'Partly Cloudy']
        }

        getWeatherMapIcon(condition, temperature) {
          const tempColor =
            temperature > 30
              ? '#ef4444'
              : temperature > 25
                ? '#f59e0b'
                : temperature > 20
                  ? '#10b981'
                  : temperature > 15
                    ? '#3b82f6'
                    : '#8b5cf6'

          const iconClass = this.getWeatherIconClass(condition)

          return L.divIcon({
            className: 'weather-marker',
            html: `<div style="background: ${tempColor}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="${iconClass}" style="color: white; font-size: 12px;"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          })
        }

        renderProvincialWeather(provinces) {
          const provincialWeather = document.getElementById('provincialWeather')
          if (!provincialWeather) return

          provincialWeather.innerHTML = ''

          provinces.forEach((province) => {
            const weather = this.generateProvinceWeather(province)
            const tempClass = this.getTemperatureClass(weather.temperature)

            const card = document.createElement('div')
            card.className = `glass-card rounded-lg p-3 provincial-weather-card ${tempClass} transition-all hover:scale-105`
            card.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h4 class="text-white font-semibold text-sm">${province.name}</h4>
                  <p class="text-gray-400 text-xs">${province.capital}</p>
                </div>
                <div class="text-right">
                  <div class="text-xl font-bold text-white">${weather.temperature}¬∞C</div>
                  <div class="text-xs text-gray-300">${weather.condition}</div>
                </div>
              </div>
              <div class="mt-2 grid grid-cols-3 gap-2 text-xs text-gray-400">
                <div><i class="fas fa-tint mr-1"></i>${weather.humidity}%</div>
                <div><i class="fas fa-wind mr-1"></i>${weather.windSpeed}km/h</div>
                <div><i class="fas fa-eye mr-1"></i>${weather.pressure}hPa</div>
              </div>
            `
            provincialWeather.appendChild(card)
          })
        }

        getTemperatureClass(temperature) {
          if (temperature > 30) return 'temp-hot'
          if (temperature > 25) return 'temp-warm'
          if (temperature > 20) return 'temp-mild'
          if (temperature > 15) return 'temp-cool'
          return 'temp-cold'
        }

        getWeatherIconClass(condition) {
          const icons = {
            Sunny: 'fas fa-sun',
            Hot: 'fas fa-sun',
            Clear: 'fas fa-sun',
            'Partly Cloudy': 'fas fa-cloud-sun',
            Cloudy: 'fas fa-cloud',
            Overcast: 'fas fa-cloud',
            'Light Rain': 'fas fa-cloud-rain',
            Rainy: 'fas fa-cloud-rain',
            Thunderstorms: 'fas fa-bolt',
            Windy: 'fas fa-wind',
            Humid: 'fas fa-eye',
          }
          return icons[condition] || 'fas fa-sun'
        }

        toggleWeatherFullscreen() {
          const weatherMapContainer = document.querySelector('.weather-map')
          if (weatherMapContainer && weatherMapContainer.requestFullscreen) {
            weatherMapContainer.requestFullscreen()
          }
        }

        async loadMultiUserData() {
          try {
            // Load real-time user data first
            await this.updateRealTimeUserDisplay()

            // Add threat assessment and active missions
            this.loadThreatAssessment()
            this.loadActiveMissions()

            // Set up periodic refresh for real-time updates
            setInterval(() => {
              if (this.realTimeUsers.size === 0) {
                this.updateRealTimeUserDisplay()
              }
            }, 30000) // Refresh every 30 seconds if no real-time data

            // Simulate multi-user data for demonstration
            const users = this.generateSimulatedUsers()
            const userLocationGrid = document.querySelector(
              '.user-location-grid'
            )
            if (userLocationGrid) {
              userLocationGrid.innerHTML = ''
            }

            users.forEach((user) => {
              const card = document.createElement('div')
              card.className = `glass-card rounded-lg p-4 transition-all hover:scale-105 border-l-4 ${this.getUserStatusColor(user.status)}`
              card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <img src="${user.avatar}" alt="${user.name}" class="w-8 h-8 rounded-full mr-2 border border-gray-600">
                    <div>
                      <h3 class="text-white font-semibold text-sm">${user.name}</h3>
                      <p class="text-gray-400 text-xs">${user.company || 'Citizen'}</p>
                    </div>
                  </div>
                  <span class="text-xs px-2 py-1 rounded-full ${this.getUserStatusBadge(user.status)}">
                    ${user.status.toUpperCase()}
                  </span>
                </div>
                <div class="text-sm text-gray-300 mb-2">
                  <div><i class="fas fa-map-marker-alt mr-2"></i>${user.location.address || `${user.location.lat.toFixed(4)}, ${user.location.lng.toFixed(4)}`}</div>
                  <div><i class="fas fa-shield-alt mr-2"></i>Threat: <span class="${this.getThreatLevelColor(user.threatLevel)}">${user.threatLevel}</span></div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                  <div><i class="fas fa-clock mr-1"></i>Last: ${this.getTimeAgo(user.lastUpdate)}</div>
                  <div><i class="fas fa-battery-three-quarters mr-1"></i>Battery: ${user.battery}%</div>
                  <div><i class="fas fa-mobile-alt mr-1"></i>${user.deviceInfo}</div>
                </div>
                <div class="mt-3 flex space-x-2">
                  <button data-action="track-user" data-user-id="${user.id}" class="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                    <i class="fas fa-eye mr-1"></i>Track
                  </button>
                  <button data-action="contact-user" data-user-id="${user.id}" class="flex-1 px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                    <i class="fas fa-phone mr-1"></i>Contact
                  </button>
                </div>
              `
              userLocationGrid.appendChild(card)
            })

            // Emit user locations to rescue tracker
            if (this.socket) {
              this.socket.emit('user-locations-update', users)
            }
          } catch (error) {
            console.log('Multi-user data simulation running')
          }
        }

        generateSimulatedUsers() {
          const names = [
            'Alice Johnson',
            'Bob Smith',
            'Carol Davis',
            'David Wilson',
            'Eva Brown',
            'Frank Miller',
          ]
          const companies = [
            'TechCorp',
            'SafeGuard Inc',
            'CrisisResponse Ltd',
            null,
            'Emergency Services',
            null,
          ]
          const statuses = ['active', 'inactive', 'emergency']
          const threats = ['Low', 'Medium', 'High']

          return names.map((name, index) => ({
            id: `user_${index + 1}`,
            name,
            company: companies[index],
            status: statuses[index % statuses.length],
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
            location: {
              lat: 40.7128 + (Math.random() - 0.5) * 0.1,
              lng: -74.006 + (Math.random() - 0.5) * 0.1,
              address: `${Math.floor(Math.random() * 9999)} Emergency St, NYC`,
            },
            threatLevel: threats[Math.floor(Math.random() * threats.length)],
            battery: Math.floor(Math.random() * 100),
            deviceInfo: `Mobile ${Math.floor(Math.random() * 5) + 1}`,
            lastUpdate: new Date(Date.now() - Math.random() * 600000), // Random time in last 10 minutes
          }))
        }

        getUserStatusColor(status) {
          const colors = {
            active: 'border-green-500',
            inactive: 'border-gray-500',
            emergency: 'border-red-500',
          }
          return colors[status] || 'border-gray-500'
        }

        getUserStatusBadge(status) {
          const badges = {
            active: 'bg-green-600 text-green-100',
            inactive: 'bg-gray-600 text-gray-100',
            emergency: 'bg-red-600 text-red-100',
          }
          return badges[status] || 'bg-gray-600 text-gray-100'
        }

        getThreatLevelColor(threatLevel) {
          const colors = {
            Low: 'text-green-400',
            Medium: 'text-yellow-400',
            High: 'text-red-400',
          }
          return colors[threatLevel] || 'text-gray-400'
        }

        trackUser(userId) {
          this.showNotification(`Tracking user ${userId}`, 'info')
          // Open rescue tracker with user focus
          window.open(`/rescue-tracker?focus=${userId}`, '_blank')
        }

        async fetchRealUserData() {
          // Simulate real-time user data from frontend connections
          // In production, this would come from Socket.IO events and database
          const realUsers = [
            {
              id: 'USER-LINTS001',
              name: 'Lintshiwe Maluleke',
              avatar: 'https://avatars.githubusercontent.com/u/84624124?v=4',
              company: 'Software Developer',
              location: {
                lat: -26.2041 + (Math.random() - 0.5) * 0.1,
                lng: 28.0473 + (Math.random() - 0.5) * 0.1,
                address: 'Johannesburg, Gauteng',
              },
              status:
                Math.random() > 0.7
                  ? 'emergency'
                  : Math.random() > 0.3
                    ? 'active'
                    : 'inactive',
              lastUpdate: new Date(Date.now() - Math.random() * 600000),
              threatLevel: ['Low', 'Medium', 'High'][
                Math.floor(Math.random() * 3)
              ],
              battery: Math.round(20 + Math.random() * 80),
              deviceInfo: 'Mobile App v2.1.0',
            },
            {
              id: 'USER-ITUMEL002',
              name: 'Itumeleng Ramokgopa',
              avatar:
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Itumeleng',
              company: 'Emergency Response Unit',
              location: {
                lat: -33.9249 + (Math.random() - 0.5) * 0.1,
                lng: 18.4241 + (Math.random() - 0.5) * 0.1,
                address: 'Cape Town, Western Cape',
              },
              status: Math.random() > 0.5 ? 'active' : 'inactive',
              lastUpdate: new Date(Date.now() - Math.random() * 300000),
              threatLevel: ['Low', 'Medium', 'High'][
                Math.floor(Math.random() * 3)
              ],
              battery: Math.round(30 + Math.random() * 70),
              deviceInfo: 'iOS App v2.0.5',
            },
            {
              id: 'USER-KAGISO003',
              name: 'Kagiso Mokwena',
              avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Kagiso',
              company: 'Crisis Response Team',
              location: {
                lat: -29.8587 + (Math.random() - 0.5) * 0.1,
                lng: 31.0218 + (Math.random() - 0.5) * 0.1,
                address: 'Durban, KwaZulu-Natal',
              },
              status: 'active',
              lastUpdate: new Date(),
              threatLevel: ['Medium', 'High'][Math.floor(Math.random() * 2)],
              battery: Math.round(40 + Math.random() * 60),
              deviceInfo: 'Android App v2.1.2',
            },
            {
              id: 'USER-BUHLE004',
              name: 'Buhle Mthembu',
              avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Buhle',
              company: 'Community Safety Officer',
              location: {
                lat: -25.7479 + (Math.random() - 0.5) * 0.1,
                lng: 28.2293 + (Math.random() - 0.5) * 0.1,
                address: 'Pretoria, Gauteng',
              },
              status: Math.random() > 0.6 ? 'emergency' : 'active',
              lastUpdate: new Date(Date.now() - Math.random() * 180000),
              threatLevel: ['Low', 'Medium'][Math.floor(Math.random() * 2)],
              battery: Math.round(50 + Math.random() * 50),
              deviceInfo: 'Web App v1.9.8',
            },
          ]

          return realUsers
        }

        async loadThreatAssessment() {
          const threatContainer = document.createElement('div')
          threatContainer.className = 'glass-card rounded-xl p-6 mt-6'
          threatContainer.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">
              <i class="fas fa-shield-alt text-red-400 mr-3"></i>
              Threat Assessment Matrix
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass-card rounded-lg p-4 border-l-4 border-red-500">
                <h3 class="text-red-400 font-semibold">High Risk Areas</h3>
                <p class="text-gray-300 text-sm mt-2">3 active threats detected</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>‚Ä¢ Johannesburg CBD - Protest activity</div>
                  <div>‚Ä¢ Cape Town N2 - Traffic incident</div>
                  <div>‚Ä¢ Durban Beachfront - Weather warning</div>
                </div>
              </div>
              <div class="glass-card rounded-lg p-4 border-l-4 border-yellow-500">
                <h3 class="text-yellow-400 font-semibold">Medium Risk Areas</h3>
                <p class="text-gray-300 text-sm mt-2">5 areas under monitoring</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>‚Ä¢ Pretoria Central - Crowd gathering</div>
                  <div>‚Ä¢ Port Elizabeth Harbor - Security alert</div>
                  <div>‚Ä¢ Bloemfontein Mall - Medical emergency</div>
                </div>
              </div>
              <div class="glass-card rounded-lg p-4 border-l-4 border-green-500">
                <h3 class="text-green-400 font-semibold">Safe Zones</h3>
                <p class="text-gray-300 text-sm mt-2">All other areas nominal</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>‚Ä¢ Northern Cape - All clear</div>
                  <div>‚Ä¢ Free State Rural - Normal activity</div>
                  <div>‚Ä¢ Limpopo Region - Stable</div>
                </div>
              </div>
            </div>
          `

          const mainContainer = document.querySelector('.max-w-7xl')
          if (mainContainer) {
            mainContainer.appendChild(threatContainer)
          }
        }

        async loadActiveMissions() {
          const missionsContainer = document.createElement('div')
          missionsContainer.className = 'glass-card rounded-xl p-6 mt-6'
          missionsContainer.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">
              <i class="fas fa-tasks text-blue-400 mr-3"></i>
              Active Missions Control
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Ongoing Operations</h3>
                <div class="space-y-3">
                  <div class="glass-card rounded-lg p-4 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                      <h4 class="text-white font-semibold">RESCUE-001</h4>
                      <span class="text-xs px-2 py-1 bg-red-600 rounded-full">CRITICAL</span>
                    </div>
                    <p class="text-gray-300 text-sm mt-1">Medical emergency - Johannesburg</p>
                    <p class="text-gray-400 text-xs mt-2">Assigned: Lintshiwe Maluleke</p>
                  </div>
                  <div class="glass-card rounded-lg p-4 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                      <h4 class="text-white font-semibold">ASSIST-002</h4>
                      <span class="text-xs px-2 py-1 bg-yellow-600 rounded-full">MEDIUM</span>
                    </div>
                    <p class="text-gray-300 text-sm mt-1">Traffic assistance - Cape Town</p>
                    <p class="text-gray-400 text-xs mt-2">Assigned: Itumeleng Ramokgopa</p>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Mission Statistics</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-400">12</div>
                    <div class="text-gray-400 text-sm">Completed Today</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-400">5</div>
                    <div class="text-gray-400 text-sm">In Progress</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-400">2</div>
                    <div class="text-gray-400 text-sm">High Priority</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-400">96%</div>
                    <div class="text-gray-400 text-sm">Success Rate</div>
                  </div>
                </div>
              </div>
            </div>
          `

          const mainContainer = document.querySelector('.max-w-7xl')
          if (mainContainer) {
            mainContainer.appendChild(missionsContainer)
          }
        }

        contactUser(userId) {
          const userMap = {
            'USER-LINTS001': 'Lintshiwe Maluleke',
            'USER-ITUMEL002': 'Itumeleng Ramokgopa',
            'USER-KAGISO003': 'Kagiso Mokwena',
            'USER-BUHLE004': 'Buhle Mthembu',
          }

          const userName = userMap[userId] || userId
          this.showNotification(
            `Initiating secure contact with ${userName}`,
            'success'
          )
          // Implement real contact functionality
        }
      } // Initialize the advanced dashboard

      // Add error handling and debugging for initialization
      try {
        console.log('üöÄ Initializing Agent Dashboard...')
        const dashboard = new AdvancedAgentDashboard()
        console.log('‚úÖ Agent Dashboard initialized successfully')
      } catch (error) {
        console.error('‚ùå Failed to initialize Agent Dashboard:', error)
        console.error('Stack trace:', error.stack)
      }
    </script>
  </body>
</html>
