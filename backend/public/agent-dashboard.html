<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrisisLink Agent Command Center</title>
    <!-- Tailwind CSS for development - comprehensive UI framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#10B981',
              secondary: '#3B82F6',
              danger: '#EF4444',
              warning: '#F59E0B',
              dark: '#1F2937',
            },
          },
        },
      }
    </script>
    <script>
      // Allow console warnings for debugging
      if (typeof window !== 'undefined') {
        // Only suppress GPS permission errors to reduce noise
        const originalError = console.error
        console.error = function (...args) {
          const message = args[0] && args[0].toString ? args[0].toString() : ''
          if (message.includes('GPS error') && args[1] && args[1].code === 1) {
            return // Suppress GPS permission denied errors
          }
          originalError.apply(console, args)
        }
      }
    </script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Leaflet Maps for Weather -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        min-height: 100vh;
      }

      .glow-border {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        border: 1px solid rgba(59, 130, 246, 0.5);
      }

      .emergency-glow {
        animation: emergency-pulse 2s infinite;
      }

      @keyframes emergency-pulse {
        0%,
        100% {
          box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(239, 68, 68, 0.8);
        }
      }

      .status-online {
        background: linear-gradient(45deg, #10b981, #059669);
        animation: status-pulse 3s infinite;
      }

      @keyframes status-pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .glass-morphism {
        backdrop-filter: blur(16px);
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.3);
      }

      .metric-card {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.9) 0%,
          rgba(17, 24, 39, 0.9) 100%
        );
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        border: 1px solid rgba(75, 85, 99, 0.2);
      }

      .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        border-color: rgba(59, 130, 246, 0.4);
      }

      .alert-card {
        background: linear-gradient(
          135deg,
          rgba(55, 65, 81, 0.95) 0%,
          rgba(31, 41, 55, 0.95) 100%
        );
        border-left: 4px solid #ef4444;
        transition: all 0.3s ease;
        backdrop-filter: blur(8px);
      }

      .alert-card:hover {
        transform: translateX(4px);
        border-left-width: 6px;
      }

      /* Notification System */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      }

      /* Header should stay on top */
      .command-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(16px);
        background: rgba(15, 23, 42, 0.95);
      }

      /* Main content container */
      .main-content {
        position: relative;
        z-index: 1;
        padding-top: 2rem;
      }

      /* Weather section specific styling */
      .weather-section {
        position: relative;
        z-index: 50;
        margin-bottom: 2rem;
      }

      /* User tracking section */
      .user-tracking-section {
        position: relative;
        z-index: 60;
        margin-top: 2rem;
      }

      .notification {
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      .notification.show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification.success {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.9),
          rgba(22, 163, 74, 0.9)
        );
        border-color: rgba(34, 197, 94, 0.3);
      }

      .notification.error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.9),
          rgba(220, 38, 38, 0.9)
        );
        border-color: rgba(239, 68, 68, 0.3);
      }

      .notification.warning {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.9),
          rgba(217, 119, 6, 0.9)
        );
        border-color: rgba(245, 158, 11, 0.3);
      }

      .notification.info {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.9),
          rgba(37, 99, 235, 0.9)
        );
        border-color: rgba(59, 130, 246, 0.3);
      }

      /* Weather Map Styles */
      .weather-map {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 1;
      }

      .weather-map .leaflet-container {
        z-index: 1 !important;
      }

      .weather-map .leaflet-control-container {
        z-index: 2 !important;
      }

      .weather-map .leaflet-popup {
        z-index: 3 !important;
      }

      /* Ensure all map containers have proper z-index */
      .leaflet-container {
        z-index: 1 !important;
      }

      .leaflet-pane {
        z-index: auto !important;
      }

      .leaflet-map-pane {
        z-index: 1 !important;
      }

      .leaflet-popup-pane {
        z-index: 1000 !important;
      }

      .leaflet-marker-pane {
        z-index: 600 !important;
      }

      .leaflet-shadow-pane {
        z-index: 500 !important;
      }

      /* Main content areas should have higher z-index than maps */
      .glass-card {
        position: relative;
        z-index: 10;
        backdrop-filter: blur(16px);
        background: rgba(31, 41, 55, 0.85);
        border: 1px solid rgba(75, 85, 99, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      /* Specific z-index for overlapping components */
      .threat-assessment-container,
      .missions-container,
      .user-tracking-container {
        position: relative;
        z-index: 100;
      }

      .provincial-weather-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .provincial-weather-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      }

      .temp-hot {
        border-left-color: #ef4444;
      }
      .temp-warm {
        border-left-color: #f59e0b;
      }
      .temp-mild {
        border-left-color: #10b981;
      }
      .temp-cool {
        border-left-color: #3b82f6;
      }
      .temp-cold {
        border-left-color: #8b5cf6;
      }

      /* Loading States */
      .loading {
        position: relative;
        overflow: hidden;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: loading-shimmer 1.5s infinite;
      }

      @keyframes loading-shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* Interactive Buttons */
      .interactive-btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .interactive-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .interactive-btn:active {
        transform: translateY(0);
      }

      .interactive-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.3s,
          height 0.3s;
      }

      .interactive-btn:active::before {
        width: 300px;
        height: 300px;
      }

      @keyframes ripple {
        to {
          transform: scale(2);
          opacity: 0;
        }
      }

      /* Enhanced Status Indicators */
      .status-indicator {
        position: relative;
        display: inline-block;
      }

      .status-indicator::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse-status 2s infinite;
      }

      @keyframes pulse-status {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      /* Smooth Transitions */
      * {
        transition:
          transform 0.2s ease,
          opacity 0.2s ease;
      }

      .typing-animation::after {
        content: '|';
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .radar-scan {
        position: relative;
        overflow: hidden;
      }

      .radar-scan::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(59, 130, 246, 0.2),
          transparent
        );
        animation: radar-sweep 3s infinite;
      }

      @keyframes radar-sweep {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .command-header {
        background: linear-gradient(
          135deg,
          rgba(17, 24, 39, 0.95) 0%,
          rgba(31, 41, 55, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      }

      .threat-level-critical {
        background: linear-gradient(45deg, #dc2626, #991b1b);
        animation: critical-warning 1.5s infinite;
      }

      @keyframes critical-warning {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .hologram-effect {
        position: relative;
        color: #00ff88;
        text-shadow: 0 0 10px #00ff88;
      }

      .hologram-effect::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 48%,
          rgba(0, 255, 136, 0.1) 49%,
          rgba(0, 255, 136, 0.1) 51%,
          transparent 52%
        );
        animation: hologram-glitch 2s infinite;
      }

      @keyframes hologram-glitch {
        0%,
        100% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-2px);
        }
        40% {
          transform: translateX(2px);
        }
        60% {
          transform: translateX(-1px);
        }
        80% {
          transform: translateX(1px);
        }
      }

      .agent-portrait {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: 2px solid #60a5fa;
        position: relative;
        overflow: hidden;
      }

      .agent-portrait::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: portrait-scan 4s infinite;
      }

      @keyframes portrait-scan {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="text-white min-h-screen">
    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Command Header -->
    <header class="command-header sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div
              class="agent-portrait rounded-full flex items-center justify-center"
            >
              <i class="fas fa-user-shield text-white text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold hologram-effect">
                AGENT COMMAND CENTER
              </h1>
              <p class="text-sm text-blue-300">Tactical Operations Interface</p>
            </div>
          </div>
          <div class="flex items-center space-x-6">
            <div class="text-center">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 status-online rounded-full"></div>
                <span class="text-sm font-medium">OPERATIONAL</span>
              </div>
              <p class="text-xs text-gray-400">System Status</p>
            </div>
            <div class="text-center">
              <div class="flex items-center space-x-2">
                <i class="fas fa-map-marker-alt text-green-400"></i>
                <span class="text-sm font-medium" id="currentLocationDisplay"
                  >LOCATING...</span
                >
              </div>
              <p class="text-xs text-gray-400">Current Position</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-blue-300" id="agentName">
                AGENT-7734
              </p>
              <p class="text-xs" id="agentStatus">READY FOR DEPLOYMENT</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-mono" id="currentTime">--:--:--</p>
              <p class="text-xs text-gray-400">LOCAL TIME</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Command Interface -->
    <div class="max-w-7xl mx-auto px-6 py-6 space-y-6">
      <!-- Live Weather Dashboard -->
      <div class="glass-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-white">
            <i class="fas fa-cloud-sun text-blue-400 mr-3"></i>
            Live Weather Monitoring - South Africa
          </h2>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 text-sm text-gray-300">
              <div
                class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span id="weatherStatus">Live Data</span>
            </div>
            <div class="text-xs text-gray-400">
              Last Update: <span id="weatherLastUpdate">--:--</span>
            </div>
          </div>
        </div>

        <!-- Weather Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div
            class="bg-gradient-to-r from-blue-900/50 to-blue-800/30 rounded-lg p-4 border border-blue-500/20"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-blue-300 mb-1">Average Temp</p>
                <p class="text-xl font-bold text-white" id="avgTemperature">
                  --°C
                </p>
              </div>
              <i class="fas fa-thermometer-half text-2xl text-blue-400"></i>
            </div>
          </div>
          <div
            class="bg-gradient-to-r from-yellow-900/50 to-yellow-800/30 rounded-lg p-4 border border-yellow-500/20"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-yellow-300 mb-1">Weather Alerts</p>
                <p class="text-xl font-bold text-white" id="weatherAlertCount">
                  0
                </p>
              </div>
              <i
                class="fas fa-exclamation-triangle text-2xl text-yellow-400"
              ></i>
            </div>
          </div>
          <div
            class="bg-gradient-to-r from-green-900/50 to-green-800/30 rounded-lg p-4 border border-green-500/20"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-green-300 mb-1">Provinces Online</p>
                <p class="text-xl font-bold text-white" id="provincesOnline">
                  0/9
                </p>
              </div>
              <i class="fas fa-map-marked-alt text-2xl text-green-400"></i>
            </div>
          </div>
          <div
            class="bg-gradient-to-r from-red-900/50 to-red-800/30 rounded-lg p-4 border border-red-500/20"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-red-300 mb-1">Critical Alerts</p>
                <p
                  class="text-xl font-bold text-white"
                  id="criticalWeatherAlerts"
                >
                  0
                </p>
              </div>
              <i class="fas fa-skull-crossbones text-2xl text-red-400"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Interactive Weather Map -->
          <div class="lg:col-span-2">
            <div class="glass-card rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">
                  <i class="fas fa-globe-africa text-blue-400 mr-2"></i>
                  Interactive Weather Map
                </h3>
                <div class="flex space-x-2">
                  <button
                    id="refreshWeatherBtn"
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                  </button>
                  <button
                    id="toggleWeatherLayersBtn"
                    class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs transition-colors"
                  >
                    <i class="fas fa-layer-group mr-1"></i>Layers
                  </button>
                  <button
                    onclick="toggleMapFullscreen()"
                    class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 rounded text-xs transition-colors"
                  >
                    <i class="fas fa-expand mr-1"></i>Fullscreen
                  </button>
                </div>
              </div>
              <div
                id="weatherMap"
                class="weather-map rounded-lg overflow-hidden h-96"
                style="height: 400px"
              >
                <!-- Leaflet weather map will be inserted here -->
              </div>
            </div>
          </div>

          <!-- Live Provincial Weather Panel -->
          <div class="lg:col-span-1">
            <div class="glass-card rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">
                  <i class="fas fa-list-ul text-green-400 mr-2"></i>
                  Provincial Data
                </h3>
                <div class="flex items-center space-x-2">
                  <button
                    onclick="toggleWeatherSort()"
                    class="px-2 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs"
                  >
                    <i class="fas fa-sort mr-1"></i>Sort
                  </button>
                </div>
              </div>
              <div
                id="provincialWeather"
                class="space-y-3 max-h-96 overflow-y-auto"
              >
                <!-- Loading animation -->
                <div class="text-center py-8">
                  <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"
                  ></div>
                  <p class="text-sm text-gray-400 mt-2">
                    Loading weather data...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Weather Alerts Section -->
        <div class="mt-6" id="weatherAlertsSection" style="display: none">
          <div class="glass-card rounded-lg p-4">
            <h3 class="text-lg font-semibold text-white mb-4">
              <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
              Active Weather Alerts
            </h3>
            <div id="weatherAlerts" class="space-y-3">
              <!-- Weather alerts will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Multi-User Location Tracking -->
      <div class="glass-card rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
          <i class="fas fa-users-cog text-green-400 mr-3"></i>
          Active Users Location Tracking
        </h2>
        <div
          id="userLocationGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- User location cards will be populated here -->
        </div>
      </div>

      <!-- Critical Metrics Dashboard -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="metric-card rounded-xl p-6 radar-scan">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-red-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
              </div>
              <div>
                <p class="text-red-400 text-sm font-medium">ACTIVE THREATS</p>
                <p class="text-3xl font-bold text-red-300" id="activeAlerts">
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="w-full bg-red-900/30 rounded-full h-2">
            <div
              class="bg-red-500 h-2 rounded-full"
              style="width: 0%"
              id="alertProgress"
            ></div>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-blue-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-crosshairs text-blue-400 text-xl"></i>
              </div>
              <div>
                <p class="text-blue-400 text-sm font-medium">ASSIGNMENTS</p>
                <p class="text-3xl font-bold text-blue-300" id="myAssignments">
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Mission Critical:
            <span class="text-blue-400" id="criticalCount">0</span>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-green-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-medal text-green-400 text-xl"></i>
              </div>
              <div>
                <p class="text-green-400 text-sm font-medium">COMPLETED</p>
                <p
                  class="text-3xl font-bold text-green-300"
                  id="completedToday"
                >
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Success Rate: <span class="text-green-400">98.7%</span>
          </div>
        </div>

        <div class="metric-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div
                class="w-12 h-12 bg-yellow-900/50 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-stopwatch text-yellow-400 text-xl"></i>
              </div>
              <div>
                <p class="text-yellow-400 text-sm font-medium">AVG RESPONSE</p>
                <p class="text-3xl font-bold text-yellow-300" id="avgResponse">
                  0m
                </p>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-400">
            Target: <span class="text-yellow-400">&lt; 3min</span>
          </div>
        </div>
      </div>

      <!-- Tactical Control Panel -->
      <div class="glass-morphism rounded-xl p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <button
              id="statusBtn"
              class="interactive-btn px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 glow-border"
            >
              <i class="fas fa-power-off mr-2"></i>
              OPERATIONAL
            </button>
            <button
              id="locationBtn"
              class="interactive-btn px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-satellite mr-2"></i>
              GPS SYNC
            </button>
            <button
              id="commsBtn"
              class="interactive-btn px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-broadcast-tower mr-2"></i>
              COMMS
            </button>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-center">
              <p class="text-xs text-gray-400">GPS LOCK</p>
              <p class="text-sm font-mono" id="coordinates">00.0000, 00.0000</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-gray-400">LAST SYNC</p>
              <p class="text-sm font-mono" id="lastUpdate">--:--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mission Control Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Threat Assessment Panel -->
        <div class="glass-morphism rounded-xl overflow-hidden">
          <div
            class="bg-gradient-to-r from-red-900/50 to-red-800/50 p-4 border-b border-red-700/30"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-shield-virus text-red-400 mr-3"></i>
                THREAT ASSESSMENT
              </h2>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-red-900/50 px-2 py-1 rounded-full"
                  id="availableCount"
                  >0</span
                >
                <div
                  class="w-2 h-2 bg-red-500 rounded-full animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <div class="p-6 max-h-96 overflow-y-auto">
            <div id="availableAlerts" class="space-y-4">
              <div class="text-center py-8 text-gray-400">
                <i class="fas fa-search text-4xl mb-3"></i>
                <p>Scanning for threats...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Missions Panel -->
        <div class="glass-morphism rounded-xl overflow-hidden">
          <div
            class="bg-gradient-to-r from-blue-900/50 to-blue-800/50 p-4 border-b border-blue-700/30"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-crosshairs text-blue-400 mr-3"></i>
                ACTIVE MISSIONS
              </h2>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-blue-900/50 px-2 py-1 rounded-full"
                  id="assignedCount"
                  >0</span
                >
                <div
                  class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <div class="p-6 max-h-96 overflow-y-auto">
            <div id="myAssignedAlerts" class="space-y-4">
              <div class="text-center py-8 text-gray-400">
                <i class="fas fa-satellite-dish text-4xl mb-3"></i>
                <p>Awaiting mission assignment...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Communication Panel -->
        <div class="glass-morphism rounded-xl overflow-hidden">
          <div
            class="bg-gradient-to-r from-green-900/50 to-green-800/50 p-4 border-b border-green-700/30"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-comments text-green-400 mr-3"></i>
                TEAM COMMUNICATIONS
              </h2>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-green-900/50 px-2 py-1 rounded-full"
                  id="onlineAgentsCount"
                  >0</span
                >
                <div
                  class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <div class="flex flex-col h-96">
            <!-- Messages Area -->
            <div class="flex-1 p-4 overflow-y-auto" id="messagesContainer">
              <div class="space-y-3" id="messagesList">
                <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-radio text-4xl mb-3"></i>
                  <p>Communication channel active</p>
                </div>
              </div>
            </div>

            <!-- Message Input Area -->
            <div class="border-t border-green-700/30 p-4">
              <div class="flex items-center space-x-3">
                <input
                  type="text"
                  id="messageInput"
                  placeholder="Type your message..."
                  class="flex-1 bg-gray-800/50 border border-green-700/30 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500"
                  maxlength="500"
                />
                <button
                  id="sendMessageBtn"
                  title="Send Message"
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              <div
                class="text-xs text-gray-400 mt-2 flex items-center justify-between"
              >
                <span>Press Enter to send</span>
                <span id="messageCounter">0/500</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Natural Disaster Monitoring -->
      <div class="glass-morphism rounded-xl overflow-hidden">
        <div
          class="bg-gradient-to-r from-orange-900/50 to-red-800/50 p-4 border-b border-orange-700/30"
        >
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold flex items-center">
              <i class="fas fa-exclamation-triangle text-orange-400 mr-3"></i>
              NATURAL DISASTER ALERTS
            </h2>
            <div class="flex items-center space-x-2">
              <span
                class="text-xs bg-orange-900/50 px-2 py-1 rounded-full"
                id="disasterCount"
                >0</span
              >
              <div
                class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"
              ></div>
            </div>
          </div>
          <div class="flex items-center justify-between mt-2">
            <div class="text-xs text-orange-300">
              Powered by Ambee API | Last Update:
              <span id="disasterLastUpdate">--:--</span>
            </div>
            <div class="flex items-center space-x-4 text-xs">
              <span class="text-red-400"
                >Critical: <span id="criticalDisasters">0</span></span
              >
              <span class="text-orange-400"
                >High: <span id="highDisasters">0</span></span
              >
              <span class="text-yellow-400"
                >Medium: <span id="mediumDisasters">0</span></span
              >
            </div>
          </div>
        </div>
        <div class="p-6 max-h-96 overflow-y-auto">
          <div id="naturalDisasters" class="space-y-4">
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-satellite text-4xl mb-3"></i>
              <p>Monitoring natural disasters across South Africa...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- User Communication Center -->
      <div class="glass-morphism rounded-xl overflow-hidden">
        <div
          class="bg-gradient-to-r from-purple-900/50 to-indigo-800/50 p-4 border-b border-purple-700/30"
        >
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold flex items-center">
              <i class="fas fa-users text-purple-400 mr-3"></i>
              USER COMMUNICATION CENTER
            </h2>
            <div class="flex items-center space-x-4">
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-purple-900/50 px-2 py-1 rounded-full"
                  id="activeUsersCount"
                  >0</span
                >
                <span class="text-xs text-purple-300">Active Users</span>
              </div>
              <div class="flex items-center space-x-2">
                <span
                  class="text-xs bg-red-900/50 px-2 py-1 rounded-full"
                  id="userAlertsCount"
                  >0</span
                >
                <span class="text-xs text-red-300">Emergency Alerts</span>
              </div>
              <div
                class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"
              ></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
          <!-- Emergency Alerts from Users -->
          <div class="border-r border-purple-700/30">
            <div class="bg-red-900/30 p-3 border-b border-red-700/30">
              <h3 class="font-semibold text-red-300 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Emergency Alerts
              </h3>
            </div>
            <div class="p-4 max-h-80 overflow-y-auto">
              <div id="userEmergencyAlerts" class="space-y-3">
                <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-shield-alt text-4xl mb-3"></i>
                  <p>No emergency alerts</p>
                  <p class="text-xs">Monitoring for user emergencies...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- User Messages -->
          <div>
            <div class="bg-blue-900/30 p-3 border-b border-blue-700/30">
              <h3 class="font-semibold text-blue-300 flex items-center">
                <i class="fas fa-comments mr-2"></i>
                User Messages
                <span
                  class="ml-2 text-xs bg-blue-900/50 px-2 py-1 rounded-full"
                  id="unreadMessagesCount"
                  >0</span
                >
              </h3>
            </div>
            <div class="p-4 max-h-80 overflow-y-auto">
              <div id="userMessages" class="space-y-3">
                <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-inbox text-4xl mb-3"></i>
                  <p>No messages</p>
                  <p class="text-xs">Waiting for user messages...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Response Panel -->
        <div class="border-t border-purple-700/30 p-4 bg-purple-900/20">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Selected User Info -->
            <div class="flex items-center space-x-3">
              <div
                class="w-10 h-10 bg-purple-700/50 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-user text-purple-300"></i>
              </div>
              <div>
                <p class="text-sm font-semibold" id="selectedUserId">
                  Select a user
                </p>
                <p class="text-xs text-gray-400" id="selectedUserStatus">
                  No user selected
                </p>
              </div>
            </div>

            <!-- Quick Response Buttons -->
            <div class="flex items-center space-x-2">
              <button
                class="quick-response-btn px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs"
                data-message="Help is on the way! Please stay calm."
              >
                Help Coming
              </button>
              <button
                class="quick-response-btn px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-xs"
                data-message="Please share your exact location."
              >
                Need Location
              </button>
              <button
                class="quick-response-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs"
                data-message="Can you provide more details?"
              >
                Need Details
              </button>
            </div>

            <!-- Message Input -->
            <div class="flex items-center space-x-2">
              <input
                type="text"
                id="userResponseInput"
                placeholder="Type message to user..."
                class="flex-1 bg-gray-800/50 border border-purple-700/30 rounded px-3 py-1 text-sm text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50"
              />
              <button
                id="sendUserMessageBtn"
                class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- System Status Bar -->
      <div class="glass-morphism rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
              <div
                class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span class="text-sm">NETWORK: SECURE</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
              <span class="text-sm">COMMS: ENCRYPTED</span>
            </div>
            <div class="flex items-center space-x-2">
              <div
                class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"
              ></div>
              <span class="text-sm">GPS: TRACKING</span>
            </div>
          </div>
          <div class="text-xs text-gray-400 typing-animation">
            System operational - all sensors active
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced JavaScript -->
    <script>
      class AdvancedAgentDashboard {
        constructor() {
          this.socket = null
          this.agentId =
            'AGENT-' + Math.random().toString(36).substr(2, 4).toUpperCase()
          this.agentName = this.agentId // Default agent name is the ID
          this.currentLocation = null
          this.status = 'operational'
          this.threatLevel = 'green'
          this.weatherData = {}
          this.weatherMap = null
          this.weatherSortBy = 'name'
          this.weatherLayersVisible = false

          this.init()
        }

        async init() {
          this.setupSocket()
          this.setupEventListeners()
          this.setupEventDelegation()
          this.startSystemUpdates()
          this.requestLocation()
          this.loadInitialData()
          this.startLocationTracking()
          this.initializeInterface()
          this.initializeWeatherSystem()
          this.loadMultiUserData()
          this.initializeMessaging()
          this.initializeUserCommunication()
        }

        setupEventDelegation() {
          // Handle all data-action clicks through event delegation
          document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]')
            if (!target) return

            const action = target.dataset.action
            const alertId = target.dataset.alertId
            const userId = target.dataset.userId

            switch (action) {
              case 'accept-mission':
                this.acceptMission(alertId)
                break
              case 'track-user':
                this.trackUser(userId)
                break
              case 'contact-user':
                this.contactUser(userId)
                break
              case 'weather-refresh':
                this.loadLiveWeatherData()
                break
              case 'weather-fullscreen':
                this.toggleWeatherFullscreen()
                break
            }
          })

          // Handle select changes
          document.addEventListener('change', (e) => {
            const target = e.target.closest('[data-action="update-status"]')
            if (target) {
              this.updateMissionStatus(target.dataset.alertId, target.value)
            }
          })

          // Handle notification close buttons
          document.addEventListener('click', (e) => {
            if (e.target.closest('.notification-close')) {
              e.target.closest('.notification').remove()
            }
          })
        }

        showNotification(message, type = 'info', duration = 5000) {
          const container = document.getElementById('notificationContainer')
          const notification = document.createElement('div')
          notification.className = `notification ${type}`

          notification.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <i class="fas ${this.getNotificationIcon(type)} text-xl"></i>
                <span class="font-medium">${message}</span>
              </div>
              <button class="notification-close text-white hover:text-gray-300">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `

          container.appendChild(notification)

          // Trigger animation
          setTimeout(() => notification.classList.add('show'), 100)

          // Auto remove
          setTimeout(() => {
            notification.classList.remove('show')
            setTimeout(() => notification.remove(), 300)
          }, duration)
        }

        getNotificationIcon(type) {
          const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle',
          }
          return icons[type] || icons.info
        }

        initializeInterface() {
          // Update agent name display
          document.getElementById('agentName').textContent = this.agentId

          // Start real-time clock
          this.updateClock()
          setInterval(() => this.updateClock(), 1000)

          // Initialize coordinates display
          this.updateCoordinatesDisplay()

          // Simulate system boot sequence
          setTimeout(() => this.playBootSequence(), 1000)
        }

        updateClock() {
          const now = new Date()
          document.getElementById('currentTime').textContent =
            now.toLocaleTimeString()
        }

        async updateCoordinatesDisplay() {
          const coordinatesEl = document.getElementById('coordinates')
          if (this.currentLocation && coordinatesEl) {
            // Check for known location first
            const knownLocation = this.getKnownSALocation(
              this.currentLocation.lat,
              this.currentLocation.lng
            )
            if (knownLocation) {
              coordinatesEl.textContent = knownLocation
              return
            }

            // Show coordinates initially, then resolve to location name
            coordinatesEl.textContent = `${this.currentLocation.lat.toFixed(4)}, ${this.currentLocation.lng.toFixed(4)}`

            // Get location name
            try {
              const locationName = await this.getLocationName(
                this.currentLocation.lat,
                this.currentLocation.lng
              )
              if (locationName && coordinatesEl) {
                coordinatesEl.textContent = locationName
              }
            } catch (error) {
              console.warn(
                'Failed to resolve location name for coordinates display:',
                error
              )
            }
          }
        }

        updateHeaderLocationDisplay() {
          const locationDisplay = document.getElementById(
            'currentLocationDisplay'
          )
          if (this.currentLocation && locationDisplay) {
            // Check for known South African locations first for faster display
            const knownLocation = this.getKnownSALocation(
              this.currentLocation.lat,
              this.currentLocation.lng
            )
            if (knownLocation) {
              locationDisplay.textContent = knownLocation
              locationDisplay.style.color = '#10B981' // Green color when resolved
              return
            }

            // Show coordinates initially, then get location name
            const lat = this.currentLocation.lat.toFixed(2)
            const lng = this.currentLocation.lng.toFixed(2)
            locationDisplay.textContent = `${lat}°, ${lng}°`
            locationDisplay.style.color = '#F59E0B' // Warning color while resolving

            // Get location name via reverse geocoding
            this.getLocationName(
              this.currentLocation.lat,
              this.currentLocation.lng
            )
              .then((locationName) => {
                if (locationName && locationDisplay) {
                  locationDisplay.textContent = locationName
                  locationDisplay.style.color = '#10B981' // Green color when resolved
                }
              })
              .catch((error) => {
                console.warn('Failed to get location name:', error)
                // Keep coordinates if reverse geocoding fails
                locationDisplay.style.color = '#10B981' // Green color to indicate active
              })
          } else if (locationDisplay) {
            locationDisplay.textContent = 'LOCATING...'
            locationDisplay.style.color = '#F59E0B' // Warning color
          }
        }

        getKnownSALocation(lat, lng) {
          // Common South African locations for fast lookup
          const knownLocations = [
            {
              name: 'Cape Town, Western Cape, SA',
              lat: -33.9249,
              lng: 18.4241,
              radius: 0.1,
            },
            {
              name: 'Johannesburg, Gauteng, SA',
              lat: -26.2041,
              lng: 28.0473,
              radius: 0.1,
            },
            {
              name: 'Durban, KwaZulu-Natal, SA',
              lat: -29.8587,
              lng: 31.0218,
              radius: 0.1,
            },
            {
              name: 'Port Elizabeth, Eastern Cape, SA',
              lat: -33.9608,
              lng: 25.6022,
              radius: 0.1,
            },
            {
              name: 'Bloemfontein, Free State, SA',
              lat: -29.0852,
              lng: 26.1596,
              radius: 0.1,
            },
            {
              name: 'Nelspruit, Mpumalanga, SA',
              lat: -25.4749,
              lng: 30.9694,
              radius: 0.1,
            },
            {
              name: 'Polokwane, Limpopo, SA',
              lat: -23.9045,
              lng: 29.4689,
              radius: 0.1,
            },
            {
              name: 'Kimberley, Northern Cape, SA',
              lat: -28.7282,
              lng: 24.7499,
              radius: 0.1,
            },
            {
              name: 'Mahikeng, North West, SA',
              lat: -25.8601,
              lng: 25.6402,
              radius: 0.1,
            },
            {
              name: 'Pretoria, Gauteng, SA',
              lat: -25.7479,
              lng: 28.2293,
              radius: 0.05,
            },
            {
              name: 'Stellenbosch, Western Cape, SA',
              lat: -33.9321,
              lng: 18.8602,
              radius: 0.02,
            },
          ]

          for (const location of knownLocations) {
            const distance = Math.sqrt(
              Math.pow(lat - location.lat, 2) + Math.pow(lng - location.lng, 2)
            )
            if (distance <= location.radius) {
              return location.name
            }
          }

          return null
        }

        async getLocationName(lat, lng) {
          try {
            // First try Nominatim (OpenStreetMap) reverse geocoding API
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=12&addressdetails=1`,
              {
                headers: {
                  'User-Agent': 'CrisisLink-Agent-Dashboard/1.0',
                },
              }
            )

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`)
            }

            const data = await response.json()

            if (data && data.address) {
              return this.formatLocationName(data.address, data.display_name)
            }

            return null
          } catch (error) {
            console.warn(
              'Nominatim reverse geocoding failed, trying OpenWeather fallback:',
              error
            )
            return await this.getLocationNameFromOpenWeather(lat, lng)
          }
        }

        async getLocationNameFromOpenWeather(lat, lng) {
          try {
            // Fallback to OpenWeather reverse geocoding
            const apiKey = '949678e6f2a5b82bbc459044b85563f5' // Using the working alternative key
            const response = await fetch(
              `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lng}&limit=1&appid=${apiKey}`
            )

            if (!response.ok) {
              throw new Error(
                `OpenWeather API error! status: ${response.status}`
              )
            }

            const data = await response.json()

            if (data && data.length > 0) {
              const location = data[0]
              let locationName = location.name || ''

              if (location.state && locationName !== location.state) {
                locationName += `, ${location.state}`
              }

              if (
                location.country === 'ZA' ||
                location.country === 'South Africa'
              ) {
                locationName += ', SA'
              }

              return locationName || 'Unknown Location'
            }

            return null
          } catch (error) {
            console.warn('OpenWeather reverse geocoding also failed:', error)
            return null
          }
        }

        formatLocationName(address, displayName) {
          let locationName = ''

          // Try to get the most relevant location name
          if (address.city) {
            locationName = address.city
          } else if (address.town) {
            locationName = address.town
          } else if (address.suburb) {
            locationName = address.suburb
          } else if (address.neighbourhood) {
            locationName = address.neighbourhood
          } else if (address.village) {
            locationName = address.village
          }

          // Add province/state if available
          if (address.state && locationName && locationName !== address.state) {
            locationName += `, ${address.state}`
          } else if (address.state && !locationName) {
            locationName = address.state
          }

          // Add country if in South Africa
          if (
            address.country_code === 'za' ||
            address.country === 'South Africa'
          ) {
            if (locationName) {
              locationName += ', SA'
            } else {
              locationName = 'South Africa'
            }
          }

          return (
            locationName || displayName?.split(',')[0] || 'Unknown Location'
          )
        }

        async formatLocationForDisplay(
          location,
          fallbackText = 'LOCATION UNKNOWN'
        ) {
          if (!location.latitude || !location.longitude) {
            return fallbackText
          }

          // Check for known location first
          const knownLocation = this.getKnownSALocation(
            location.latitude,
            location.longitude
          )
          if (knownLocation) {
            return knownLocation
          }

          // Try to get location name, but don't wait too long
          try {
            const locationName = await Promise.race([
              this.getLocationName(location.latitude, location.longitude),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), 2000)
              ),
            ])

            if (locationName) {
              return locationName
            }
          } catch (error) {
            // Fall through to coordinates
          }

          // Fallback to coordinates
          return `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`
        }

        playBootSequence() {
          const messages = [
            'Initializing tactical systems...',
            'Establishing secure connection...',
            'GPS lock acquired...',
            'All systems operational',
          ]

          let index = 0
          const statusEl = document.querySelector('.typing-animation')

          const showMessage = () => {
            if (index < messages.length) {
              statusEl.textContent = messages[index]
              index++
              setTimeout(showMessage, 1500)
            }
          }
          showMessage()
        }

        setupSocket() {
          this.socket = io('http://localhost:5000')

          this.socket.on('connect', () => {
            console.log('Secure connection established')
            // Join the agents room for receiving SOS alerts
            this.socket.emit('join', {
              room: 'agents',
              agentId: this.agentId,
              agentName: this.agentName,
            })
          })

          this.socket.on('new-sos-alert', (data) => {
            console.log('🚨 NEW SOS ALERT RECEIVED:', data)
            this.addRealTimeAlert(data, 'SOS')
            this.playThreatAlarm()
            this.updateThreatLevel('red')
            this.showNotification(
              `🚨 NEW SOS ALERT from ${data.userId || data.name || 'User'}`,
              'emergency'
            )
          })

          this.socket.on('emergency-alert', (data) => {
            console.log('🚨 EMERGENCY ALERT RECEIVED:', data)
            this.addRealTimeAlert(data, 'EMERGENCY')
            this.playThreatAlarm()
            this.updateThreatLevel('red')
            this.showNotification(`🚨 EMERGENCY: ${data.message}`, 'emergency')
          })

          // ============ USER COMMUNICATION EVENT HANDLERS ============

          this.socket.on('new-emergency-alert', (data) => {
            console.log('🚨 USER EMERGENCY ALERT:', data)
            this.addUserEmergencyAlert(data)
            this.playThreatAlarm()
            this.showNotification(
              `🚨 Emergency Alert from ${data.userId}`,
              'emergency'
            )
          })

          this.socket.on('user-message', (data) => {
            console.log('💬 USER MESSAGE:', data)
            this.addUserMessage(data)
            this.showNotification(`💬 Message from ${data.userId}`, 'info')
          })

          this.socket.on('user-location-update', (data) => {
            console.log('📍 User location update:', data)
            this.updateUserLocation(data)
          })

          this.socket.on('user-online', (data) => {
            console.log('👤 User online:', data)
            this.addActiveUser(data)
            this.updateUserCounts()
          })

          this.socket.on('alert-cancelled', (data) => {
            console.log('❌ Alert cancelled:', data)
            this.removeUserAlert(data.alertId)
            this.showNotification(
              `Alert ${data.alertId} cancelled by user`,
              'info'
            )
          })

          this.socket.on('message-delivered', (data) => {
            console.log('✅ Message delivered to:', data.userId)
            this.showNotification(`Message sent to ${data.userId}`, 'success')
          })

          // ============ END USER COMMUNICATION HANDLERS ============

          this.socket.on('natural-disaster-alert', (data) => {
            console.log('🌪️ NATURAL DISASTER ALERT RECEIVED:', data)
            this.addNaturalDisasterAlert(data)
            if (data.severity === 'critical') {
              this.playThreatAlarm()
              this.updateThreatLevel('red')
            } else if (data.severity === 'high') {
              this.updateThreatLevel('orange')
            }
            this.showNotification(
              `🌪️ NATURAL DISASTER: ${data.title}`,
              data.severity === 'critical' ? 'emergency' : 'warning'
            )
          })

          this.socket.on('sos-assigned', (data) => {
            this.removeThreatAlert(data.sosId)
          })

          this.socket.on('sos-cancelled', (data) => {
            this.removeAlert(data.sosId)
          })

          // Weather socket events
          this.socket.on('weather-update', (data) => {
            console.log('🌤️ Weather update received:', data)
            this.updateProvinceWeather(data.province, data.data)
            this.updateWeatherStats()
          })

          this.socket.on('weather-alert', (data) => {
            console.log('⚠️ Weather alert received:', data)
            this.addWeatherAlert(data)
            this.showNotification(
              `⚠️ Weather Alert: ${data.province}`,
              'warning'
            )
          })
        }

        setupEventListeners() {
          document
            .getElementById('statusBtn')
            .addEventListener('click', (e) => {
              this.addRippleEffect(e.target)
              this.toggleOperationalStatus()
            })

          document
            .getElementById('locationBtn')
            .addEventListener('click', (e) => {
              this.addRippleEffect(e.target)
              this.showButtonLoading(e.target, 'Syncing...')
              this.requestLocation()
              this.playSystemSound()
              setTimeout(
                () => this.resetButtonLoading(e.target, 'GPS SYNC'),
                2000
              )
            })

          document.getElementById('commsBtn').addEventListener('click', (e) => {
            this.addRippleEffect(e.target)
            this.showButtonLoading(e.target, 'Testing...')
            this.testCommunications()
            setTimeout(() => this.resetButtonLoading(e.target, 'COMMS'), 3000)
          })

          // Add click animations to all metric cards
          document.querySelectorAll('.metric-card').forEach((card) => {
            card.addEventListener('click', () => {
              card.style.transform = 'scale(0.95)'
              setTimeout(() => {
                card.style.transform = ''
              }, 150)
            })
          })
        }

        addRippleEffect(button) {
          const existingRipple = button.querySelector('.ripple')
          if (existingRipple) existingRipple.remove()

          const ripple = document.createElement('span')
          ripple.classList.add('ripple')
          ripple.style.cssText = `
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            margin-left: -50px;
            margin-top: -50px;
          `

          button.style.position = 'relative'
          button.appendChild(ripple)

          setTimeout(() => ripple.remove(), 600)
        }

        showButtonLoading(button, text) {
          const originalContent = button.innerHTML
          button.dataset.originalContent = originalContent
          button.innerHTML = `
            <i class="fas fa-spinner fa-spin mr-2"></i>
            ${text}
          `
          button.disabled = true
          button.style.opacity = '0.7'
        }

        resetButtonLoading(button, text) {
          const icon = button.dataset.originalContent.match(/<i[^>]*><\/i>/)[0]
          button.innerHTML = `${icon} ${text}`
          button.disabled = false
          button.style.opacity = '1'
        }

        showLoadingStates() {
          const metricCards = document.querySelectorAll('.metric-card')
          metricCards.forEach((card) => {
            card.classList.add('loading')
            setTimeout(() => card.classList.remove('loading'), 2000)
          })
        }

        async loadInitialData() {
          // Show loading states
          this.showLoadingStates()

          try {
            this.showNotification('Loading mission data...', 'info', 2000)
            const response = await fetch('/api/admin/alerts')
            const data = await response.json()

            if (data.alerts) {
              data.alerts.forEach((alert) => {
                if (!alert.assigned_agent && alert.status === 'pending') {
                  this.addThreatAlert(alert)
                } else if (
                  alert.assigned_agent &&
                  alert.assigned_agent.id === this.agentId
                ) {
                  this.addActiveMission(alert)
                }
              })
            }

            this.updateAllMetrics()
          } catch (error) {
            console.error('Data loading error:', error)
          }
        }

        addThreatAlert(alert) {
          const container = document.getElementById('availableAlerts')

          // Clear placeholder if it exists
          if (container.querySelector('.text-center')) {
            container.innerHTML = ''
          }

          const alertEl = this.createThreatElement(alert)
          container.appendChild(alertEl)
          this.updateCounts()
        }

        addActiveMission(alert) {
          const container = document.getElementById('myAssignedAlerts')

          // Clear placeholder if it exists
          if (container.querySelector('.text-center')) {
            container.innerHTML = ''
          }

          const alertEl = this.createMissionElement(alert)
          container.appendChild(alertEl)
          this.updateCounts()
        }

        addRealTimeAlert(data, type = 'SOS') {
          console.log('📍 Processing real-time alert:', data)

          // Format the alert data to match expected structure
          const alert = {
            id: data.alertId || `${type}-${Date.now()}`,
            userId: data.userId || data.name || 'Unknown User',
            emergency_type: type,
            description: data.message || `${type} request from user`,
            location: data.location || {},
            created_at: new Date().toISOString(),
            status: 'active',
          }

          // Add location details if available
          if (data.location) {
            if (data.location.lat) alert.location.latitude = data.location.lat
            if (data.location.lng) alert.location.longitude = data.location.lng
            if (data.location.address)
              alert.location.address = data.location.address
          }

          console.log('📋 Formatted alert for display:', alert)

          // Add to available alerts
          this.addThreatAlert(alert)

          // Also update map if location is available
          if (alert.location.latitude && alert.location.longitude) {
            this.addAlertToMap(alert)
          }
        }

        addAlertToMap(alert) {
          if (this.map && alert.location.latitude && alert.location.longitude) {
            const marker = L.marker([
              alert.location.latitude,
              alert.location.longitude,
            ])
              .addTo(this.map)
              .bindPopup(
                `
                <div class="text-sm">
                  <strong>🚨 ${alert.emergency_type || 'ALERT'}</strong><br>
                  User: ${alert.userId}<br>
                  ${alert.description || 'Emergency assistance required'}<br>
                  <small>ID: ${alert.id}</small>
                </div>
              `
              )
              .openPopup()

            // Store marker reference for potential cleanup
            if (!this.alertMarkers) this.alertMarkers = []
            this.alertMarkers.push({ alertId: alert.id, marker })
          }
        }

        addNaturalDisasterAlert(disaster) {
          console.log('📋 Processing natural disaster alert:', disaster)

          const container = document.getElementById('naturalDisasters')

          // Clear placeholder if it exists
          if (container.querySelector('.text-center')) {
            container.innerHTML = ''
          }

          const alertEl = this.createDisasterElement(disaster)
          container.appendChild(alertEl)

          // Update disaster counts
          this.updateDisasterCounts()

          // Add to map if coordinates available
          if (
            disaster.location &&
            disaster.location.lat &&
            disaster.location.lng
          ) {
            this.addDisasterToMap(disaster)
          }
        }

        createDisasterElement(disaster) {
          const div = document.createElement('div')
          const severityClass = this.getDisasterSeverityClass(disaster.severity)
          div.className = `alert-card rounded-lg p-4 ${severityClass}`
          div.dataset.disasterId = disaster.id

          const timeAgo = this.getTimeAgo(disaster.timestamp)
          const locationName = disaster.location?.name || 'Unknown Location'

          div.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-3 h-3 rounded-full ${this.getDisasterIndicatorClass(disaster.severity)}"></div>
                <span class="font-bold text-orange-300">DISASTER-${disaster.id.split('-')[1]}</span>
                <span class="text-xs bg-orange-900/50 px-2 py-1 rounded uppercase font-mono">${disaster.disasterType}</span>
              </div>
              <span class="text-xs text-gray-400 font-mono">${timeAgo}</span>
            </div>

            <div class="text-sm text-gray-300 mb-3 font-mono">
              ${disaster.description}
            </div>

            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-400 font-mono">
                <i class="fas fa-map-marker-alt mr-1"></i>
                ${locationName}
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs px-2 py-1 rounded ${this.getSeverityBadgeClass(disaster.severity)}">
                  ${disaster.severity.toUpperCase()}
                </span>
                <button onclick="this.viewDisasterDetails('${disaster.id}')" 
                        class="text-xs px-2 py-1 bg-blue-900/50 hover:bg-blue-800/50 rounded transition-colors">
                  VIEW
                </button>
              </div>
            </div>

            <div class="mt-3 text-xs text-gray-500 border-t border-gray-700 pt-2">
              Source: ${disaster.source} | ${new Date(disaster.timestamp).toLocaleString()}
            </div>
          `

          return div
        }

        getDisasterSeverityClass(severity) {
          switch (severity) {
            case 'critical':
              return 'border-l-4 border-red-500 bg-red-900/20'
            case 'high':
              return 'border-l-4 border-orange-500 bg-orange-900/20'
            case 'medium':
              return 'border-l-4 border-yellow-500 bg-yellow-900/20'
            default:
              return 'border-l-4 border-blue-500 bg-blue-900/20'
          }
        }

        getDisasterIndicatorClass(severity) {
          switch (severity) {
            case 'critical':
              return 'bg-red-500 animate-pulse'
            case 'high':
              return 'bg-orange-500'
            case 'medium':
              return 'bg-yellow-500'
            default:
              return 'bg-blue-500'
          }
        }

        getSeverityBadgeClass(severity) {
          switch (severity) {
            case 'critical':
              return 'bg-red-900/50 text-red-300'
            case 'high':
              return 'bg-orange-900/50 text-orange-300'
            case 'medium':
              return 'bg-yellow-900/50 text-yellow-300'
            default:
              return 'bg-blue-900/50 text-blue-300'
          }
        }

        addDisasterToMap(disaster) {
          if (this.map && disaster.location.lat && disaster.location.lng) {
            const icon = this.getDisasterIcon(disaster.disasterType)
            const marker = L.marker([
              disaster.location.lat,
              disaster.location.lng,
            ]).addTo(this.map).bindPopup(`
                <div class="text-sm">
                  <strong>🌪️ ${disaster.disasterType}</strong><br>
                  Location: ${disaster.location.name}<br>
                  Severity: ${disaster.severity.toUpperCase()}<br>
                  ${disaster.description}<br>
                  <small>ID: ${disaster.id}</small>
                </div>
              `)

            // Store marker reference for cleanup
            if (!this.disasterMarkers) this.disasterMarkers = []
            this.disasterMarkers.push({ disasterId: disaster.id, marker })
          }
        }

        getDisasterIcon(disasterType) {
          const type = disasterType.toLowerCase()
          if (type.includes('earthquake')) return '🌍'
          if (type.includes('flood')) return '🌊'
          if (type.includes('fire') || type.includes('wildfire')) return '🔥'
          if (type.includes('storm') || type.includes('cyclone')) return '🌪️'
          if (type.includes('drought')) return '🌵'
          return '⚠️'
        }

        updateDisasterCounts() {
          const container = document.getElementById('naturalDisasters')
          const disasters = container.querySelectorAll('[data-disaster-id]')

          let critical = 0,
            high = 0,
            medium = 0

          disasters.forEach((el) => {
            const severity = el.className.includes('border-red-500')
              ? 'critical'
              : el.className.includes('border-orange-500')
                ? 'high'
                : el.className.includes('border-yellow-500')
                  ? 'medium'
                  : 'low'

            if (severity === 'critical') critical++
            else if (severity === 'high') high++
            else if (severity === 'medium') medium++
          })

          document.getElementById('disasterCount').textContent =
            disasters.length
          document.getElementById('criticalDisasters').textContent = critical
          document.getElementById('highDisasters').textContent = high
          document.getElementById('mediumDisasters').textContent = medium
          document.getElementById('disasterLastUpdate').textContent =
            new Date().toLocaleTimeString()
        }

        viewDisasterDetails(disasterId) {
          // This could open a modal or detailed view
          console.log('Viewing disaster details for:', disasterId)
          this.showNotification(
            'Disaster details view - Feature coming soon',
            'info'
          )
        }

        async createThreatElement(alert) {
          const div = document.createElement('div')
          div.className = 'alert-card rounded-lg p-4 emergency-glow'
          div.dataset.alertId = alert.id

          const timeAgo = this.getTimeAgo(alert.created_at || alert.createdAt)
          const emergencyType =
            alert.emergency_type || alert.emergencyType || 'UNKNOWN'
          const location = alert.location || {}

          // Get location display text
          const locationText = await this.formatLocationForDisplay(
            location,
            'COORDINATES UNKNOWN'
          )

          div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="threat-level-critical w-3 h-3 rounded-full"></div>
                            <span class="font-bold text-red-300">THREAT-${alert.id}</span>
                            <span class="text-xs bg-red-900/50 px-2 py-1 rounded uppercase font-mono">${emergencyType}</span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">${timeAgo}</span>
                    </div>

                    <div class="text-sm text-gray-300 mb-3 font-mono">
                        ${alert.description || 'EMERGENCY ASSISTANCE REQUIRED'}
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-400 font-mono">
                            <i class="fas fa-crosshairs mr-1"></i>
                            ${locationText}
                        </div>

                        <button data-action="accept-mission" data-alert-id="${alert.id}"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold text-xs transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-bullseye mr-1"></i>
                            ACCEPT MISSION
                        </button>
                    </div>
                `

          return div
        }

        createMissionElement(alert) {
          const div = document.createElement('div')
          div.className = 'alert-card rounded-lg p-4 border-l-4 border-blue-500'
          div.dataset.alertId = alert.id

          const timeAgo = this.getTimeAgo(alert.created_at || alert.createdAt)
          const emergencyType =
            alert.emergency_type || alert.emergencyType || 'CLASSIFIED'
          const location = alert.location || {}

          div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                            <span class="font-bold text-blue-300">MISSION-${alert.id}</span>
                            <span class="text-xs bg-blue-900/50 px-2 py-1 rounded uppercase font-mono">${emergencyType}</span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">${timeAgo}</span>
                    </div>

                    <div class="text-sm text-gray-300 mb-3 font-mono">
                        ${alert.description || 'MISSION DETAILS CLASSIFIED'}
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-400 font-mono">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <span class="location-display" data-lat="${location.latitude}" data-lng="${location.longitude}">
                                ${location.latitude ? `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}` : 'LOCATION CLASSIFIED'}
                            </span>
                        </div>

                        <select data-action="update-status" data-alert-id="${alert.id}"
                                class="text-xs bg-gray-700 text-white rounded px-3 py-1 font-mono border border-blue-500/30">
                            <option value="assigned" ${alert.status === 'assigned' ? 'selected' : ''}>ASSIGNED</option>
                            <option value="en_route" ${alert.status === 'en_route' ? 'selected' : ''}>EN ROUTE</option>
                            <option value="arrived" ${alert.status === 'arrived' ? 'selected' : ''}>ON SITE</option>
                            <option value="completed" ${alert.status === 'completed' ? 'selected' : ''}>MISSION COMPLETE</option>
                        </select>
                    </div>
                `

          return div
        }

        async acceptMission(alertId) {
          try {
            const response = await fetch(`/api/sos/${alertId}/assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ agentId: this.agentId }),
            })

            if (response.ok) {
              const alertEl = document.querySelector(
                `[data-alert-id="${alertId}"]`
              )
              if (alertEl) {
                alertEl.remove()
                this.updateCounts()
                this.playMissionAcceptedSound()
              }
            }
          } catch (error) {
            console.error('Mission assignment error:', error)
          }
        }

        async updateMissionStatus(alertId, status) {
          try {
            const response = await fetch(`/api/sos/${alertId}/status`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status }),
            })

            if (response.ok && status === 'completed') {
              const alertEl = document.querySelector(
                `[data-alert-id="${alertId}"]`
              )
              if (alertEl) {
                alertEl.remove()
                this.updateCounts()
                this.playMissionCompleteSound()
              }
            }
          } catch (error) {
            console.error('Status update error:', error)
          }
        }

        updateCounts() {
          const availableCount =
            document.getElementById('availableAlerts').children.length
          const assignedCount =
            document.getElementById('myAssignedAlerts').children.length

          document.getElementById('availableCount').textContent = availableCount
          document.getElementById('assignedCount').textContent = assignedCount
          document.getElementById('activeAlerts').textContent = availableCount
          document.getElementById('myAssignments').textContent = assignedCount
          document.getElementById('criticalCount').textContent = Math.floor(
            availableCount * 0.3
          )

          // Update alert progress bar
          const progressBar = document.getElementById('alertProgress')
          const progressPercent = Math.min((availableCount / 10) * 100, 100)
          progressBar.style.width = `${progressPercent}%`
        }

        async updateAllMetrics() {
          try {
            const response = await fetch('/api/admin/stats')
            const stats = await response.json()

            document.getElementById('activeAlerts').textContent =
              stats.activeAlerts || 0
            document.getElementById('avgResponse').textContent =
              `${stats.responseTime || 0}m`
            document.getElementById('completedToday').textContent =
              Math.floor(Math.random() * 15) + 5
          } catch (error) {
            console.error('Metrics update error:', error)
          }
        }

        toggleOperationalStatus() {
          this.status =
            this.status === 'operational' ? 'standby' : 'operational'
          const btn = document.getElementById('statusBtn')
          const statusEl = document.getElementById('agentStatus')

          if (this.status === 'operational') {
            btn.className =
              'interactive-btn px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 glow-border'
            btn.innerHTML = '<i class="fas fa-power-off mr-2"></i>OPERATIONAL'
            statusEl.textContent = 'READY FOR DEPLOYMENT'
            this.showNotification(
              'Status: Agent operational and ready for deployment',
              'success'
            )
          } else {
            btn.className =
              'interactive-btn px-6 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105'
            btn.innerHTML = '<i class="fas fa-pause mr-2"></i>STANDBY'
            statusEl.textContent = 'ON STANDBY'
            this.showNotification('Status: Agent placed on standby', 'warning')
          }

          this.playSystemSound()
        }

        requestLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                this.currentLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                }
                this.updateCoordinatesDisplay()
                this.updateHeaderLocationDisplay()
                this.updateLastUpdate()
                this.showNotification(
                  'Location updated successfully',
                  'success'
                )
              },
              (error) => {
                // Handle GPS errors silently - no console logging
                this.handleLocationError(error)
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000,
              }
            )
          } else {
            this.showNotification(
              'Geolocation not supported by this browser',
              'error'
            )
            this.useDefaultLocation()
          }
        }

        handleLocationError(error) {
          let message = 'Unable to get location: '
          switch (error.code) {
            case error.PERMISSION_DENIED:
              message +=
                'Location access denied. Please enable location permissions.'
              break
            case error.POSITION_UNAVAILABLE:
              message += 'Location information unavailable.'
              break
            case error.TIMEOUT:
              message += 'Location request timed out.'
              break
            default:
              message += 'Unknown location error.'
              break
          }

          this.showNotification(message, 'warning')
          this.useDefaultLocation()
        }

        useDefaultLocation() {
          // Use Johannesburg as default location
          this.currentLocation = {
            lat: -26.2041,
            lng: 28.0473,
          }
          this.updateCoordinatesDisplay()
          this.updateHeaderLocationDisplay()
          this.showNotification('Using default location: Johannesburg', 'info')
        }

        startLocationTracking() {
          if (navigator.geolocation) {
            setInterval(() => {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  this.currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                  }

                  if (this.socket) {
                    this.socket.emit('agent-location-update', {
                      agentId: this.agentId,
                      location: this.currentLocation,
                    })
                  }

                  this.updateCoordinatesDisplay()
                  this.updateHeaderLocationDisplay()
                  this.updateLastUpdate()
                },
                (error) => {
                  // Silently handle location errors during tracking to avoid spam
                  if (error.code === error.PERMISSION_DENIED) {
                    // Stop trying to track if permission is denied
                    clearInterval(this.locationTrackingInterval)
                  }
                },
                {
                  enableHighAccuracy: false, // Use less accurate but faster GPS for tracking
                  timeout: 5000,
                  maximumAge: 30000,
                }
              )
            }, 15000) // Update every 15 seconds for better tracking
          }
        }

        startSystemUpdates() {
          // Auto-refresh metrics every 30 seconds
          setInterval(() => {
            this.updateAllMetrics()
          }, 30000)
        }

        updateLastUpdate() {
          const now = new Date()
          document.getElementById('lastUpdate').textContent =
            now.toLocaleTimeString()
        }

        testCommunications() {
          this.showNotification(
            'Testing communication systems...',
            'info',
            2000
          )

          // Simulate various communication tests
          const tests = [
            { name: 'Radio frequency', delay: 1000, success: true },
            { name: 'Satellite uplink', delay: 2000, success: true },
            {
              name: 'Emergency network',
              delay: 3000,
              success: Math.random() > 0.2,
            },
          ]

          tests.forEach((test) => {
            setTimeout(() => {
              if (test.success) {
                this.showNotification(
                  `${test.name}: Connection verified`,
                  'success',
                  3000
                )
              } else {
                this.showNotification(
                  `${test.name}: Connection failed`,
                  'warning',
                  3000
                )
              }
            }, test.delay)
          })

          setTimeout(() => {
            this.showNotification('Communication test completed', 'success')
            this.playSystemSound()
          }, 3500)
        }

        removeThreatAlert(alertId) {
          const alertEl = document.querySelector(
            `#availableAlerts [data-alert-id="${alertId}"]`
          )
          if (alertEl) {
            alertEl.remove()
            this.updateCounts()
          }
        }

        removeAlert(alertId) {
          const alertEl = document.querySelector(`[data-alert-id="${alertId}"]`)
          if (alertEl) {
            alertEl.remove()
            this.updateCounts()
          }
        }

        updateThreatLevel(level) {
          this.threatLevel = level
          // Could add visual indicators for threat level changes
        }

        getTimeAgo(dateString) {
          const now = new Date()
          const past = new Date(dateString)
          const diffMs = now - past
          const diffMins = Math.floor(diffMs / 60000)

          if (diffMins < 1) return 'JUST NOW'
          if (diffMins < 60) return `${diffMins}m AGO`

          const diffHours = Math.floor(diffMins / 60)
          if (diffHours < 24) return `${diffHours}h AGO`

          const diffDays = Math.floor(diffHours / 24)
          return `${diffDays}d AGO`
        }

        // Enhanced sound system
        playThreatAlarm() {
          this.createSound(
            [800, 600, 800, 600],
            [0.2, 0.2, 0.2, 0.2],
            [0.1, 0.1, 0.1, 0.1]
          )
        }

        playMissionAcceptedSound() {
          this.createSound(
            [440, 554, 659],
            [0.15, 0.15, 0.3],
            [0.08, 0.08, 0.08]
          )
        }

        playMissionCompleteSound() {
          this.createSound(
            [523, 659, 784, 1047],
            [0.2, 0.2, 0.2, 0.4],
            [0.1, 0.1, 0.1, 0.1]
          )
        }

        playSystemSound() {
          this.createSound([1000], [0.1], [0.05])
        }

        createSound(frequencies, durations, volumes) {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)()
          let currentTime = audioContext.currentTime

          frequencies.forEach((freq, index) => {
            const oscillator = audioContext.createOscillator()
            const gainNode = audioContext.createGain()

            oscillator.connect(gainNode)
            gainNode.connect(audioContext.destination)

            oscillator.frequency.value = freq
            gainNode.gain.value = volumes[index] || 0.1

            oscillator.start(currentTime)
            oscillator.stop(currentTime + durations[index])

            currentTime += durations[index] + 0.05 // Small gap between tones
          })
        }

        // Fallback weather data for demo when API fails
        loadFallbackWeatherData() {
          const provinces = [
            'Western Cape',
            'Gauteng',
            'KwaZulu-Natal',
            'Eastern Cape',
            'Free State',
            'Mpumalanga',
            'Limpopo',
            'Northern Cape',
            'North West',
          ]

          this.weatherData = {}
          provinces.forEach((province, index) => {
            this.weatherData[province] = {
              province,
              city: [
                'Cape Town',
                'Johannesburg',
                'Durban',
                'Port Elizabeth',
                'Bloemfontein',
                'Nelspruit',
                'Polokwane',
                'Kimberley',
                'Mafikeng',
              ][index],
              temperature: Math.round(18 + Math.random() * 12),
              humidity: Math.round(40 + Math.random() * 40),
              windSpeed: Math.round(Math.random() * 20),
              condition: ['Clear', 'Partly Cloudy', 'Cloudy'][
                Math.floor(Math.random() * 3)
              ],
              description: 'simulated data',
              icon: '01d',
              alerts: [],
              coordinates: {
                lat: -30 + Math.random() * 10,
                lon: 20 + Math.random() * 15,
              },
              lastUpdated: new Date().toISOString(),
              isSimulated: true,
            }
          })

          this.updateWeatherDisplay()
          this.updateWeatherMap()
          this.updateWeatherStats()
          console.log('🔄 Using fallback weather data')
        }

        async loadMultiUserData() {
          try {
            // Load real-time user data first
            await this.updateRealTimeUserDisplay()

            // Add threat assessment and active missions
            this.loadThreatAssessment()
            this.loadActiveMissions()

            // Set up periodic refresh for real-time updates
            setInterval(() => {
              if (this.realTimeUsers.size === 0) {
                this.updateRealTimeUserDisplay()
              }
            }, 30000) // Refresh every 30 seconds if no real-time data

            // Simulate multi-user data for demonstration
            const users = this.generateSimulatedUsers()
            const userLocationGrid = document.querySelector(
              '.user-location-grid'
            )
            if (userLocationGrid) {
              userLocationGrid.innerHTML = ''
            }

            users.forEach((user) => {
              const card = document.createElement('div')
              card.className = `glass-card rounded-lg p-4 transition-all hover:scale-105 border-l-4 ${this.getUserStatusColor(user.status)}`
              card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <img src="${user.avatar}" alt="${user.name}" class="w-8 h-8 rounded-full mr-2 border border-gray-600">
                    <div>
                      <h3 class="text-white font-semibold text-sm">${user.name}</h3>
                      <p class="text-gray-400 text-xs">${user.company || 'Citizen'}</p>
                    </div>
                  </div>
                  <span class="text-xs px-2 py-1 rounded-full ${this.getUserStatusBadge(user.status)}">
                    ${user.status.toUpperCase()}
                  </span>
                </div>
                <div class="text-sm text-gray-300 mb-2">
                  <div><i class="fas fa-map-marker-alt mr-2"></i>${user.location.address || `${user.location.lat.toFixed(4)}, ${user.location.lng.toFixed(4)}`}</div>
                  <div><i class="fas fa-shield-alt mr-2"></i>Threat: <span class="${this.getThreatLevelColor(user.threatLevel)}">${user.threatLevel}</span></div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                  <div><i class="fas fa-clock mr-1"></i>Last: ${this.getTimeAgo(user.lastUpdate)}</div>
                  <div><i class="fas fa-battery-three-quarters mr-1"></i>Battery: ${user.battery}%</div>
                  <div><i class="fas fa-mobile-alt mr-1"></i>${user.deviceInfo}</div>
                </div>
                <div class="mt-3 flex space-x-2">
                  <button data-action="track-user" data-user-id="${user.id}" class="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                    <i class="fas fa-eye mr-1"></i>Track
                  </button>
                  <button data-action="contact-user" data-user-id="${user.id}" class="flex-1 px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                    <i class="fas fa-phone mr-1"></i>Contact
                  </button>
                </div>
              `
              userLocationGrid.appendChild(card)
            })

            // Emit user locations to rescue tracker
            if (this.socket) {
              this.socket.emit('user-locations-update', users)
            }
          } catch (error) {
            console.log('Multi-user data simulation running')
          }
        }

        generateSimulatedUsers() {
          const names = [
            'Alice Johnson',
            'Bob Smith',
            'Carol Davis',
            'David Wilson',
            'Eva Brown',
            'Frank Miller',
          ]
          const companies = [
            'TechCorp',
            'SafeGuard Inc',
            'CrisisResponse Ltd',
            null,
            'Emergency Services',
            null,
          ]
          const statuses = ['active', 'inactive', 'emergency']
          const threats = ['Low', 'Medium', 'High']

          return names.map((name, index) => ({
            id: `user_${index + 1}`,
            name,
            company: companies[index],
            status: statuses[index % statuses.length],
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
            location: {
              lat: 40.7128 + (Math.random() - 0.5) * 0.1,
              lng: -74.006 + (Math.random() - 0.5) * 0.1,
              address: `${Math.floor(Math.random() * 9999)} Emergency St, NYC`,
            },
            threatLevel: threats[Math.floor(Math.random() * threats.length)],
            battery: Math.floor(Math.random() * 100),
            deviceInfo: `Mobile ${Math.floor(Math.random() * 5) + 1}`,
            lastUpdate: new Date(Date.now() - Math.random() * 600000), // Random time in last 10 minutes
          }))
        }

        getUserStatusColor(status) {
          const colors = {
            active: 'border-green-500',
            inactive: 'border-gray-500',
            emergency: 'border-red-500',
          }
          return colors[status] || 'border-gray-500'
        }

        getUserStatusBadge(status) {
          const badges = {
            active: 'bg-green-600 text-green-100',
            inactive: 'bg-gray-600 text-gray-100',
            emergency: 'bg-red-600 text-red-100',
          }
          return badges[status] || 'bg-gray-600 text-gray-100'
        }

        getThreatLevelColor(threatLevel) {
          const colors = {
            Low: 'text-green-400',
            Medium: 'text-yellow-400',
            High: 'text-red-400',
          }
          return colors[threatLevel] || 'text-gray-400'
        }

        trackUser(userId) {
          this.showNotification(`Tracking user ${userId}`, 'info')
          // Open rescue tracker with user focus
          window.open(`/rescue-tracker?focus=${userId}`, '_blank')
        }

        async fetchRealUserData() {
          // Simulate real-time user data from frontend connections
          // In production, this would come from Socket.IO events and database
          const realUsers = [
            {
              id: 'USER-LINTS001',
              name: 'Lintshiwe Maluleke',
              avatar: 'https://avatars.githubusercontent.com/u/84624124?v=4',
              company: 'Software Developer',
              location: {
                lat: -26.2041 + (Math.random() - 0.5) * 0.1,
                lng: 28.0473 + (Math.random() - 0.5) * 0.1,
                address: 'Johannesburg, Gauteng',
              },
              status:
                Math.random() > 0.7
                  ? 'emergency'
                  : Math.random() > 0.3
                    ? 'active'
                    : 'inactive',
              lastUpdate: new Date(Date.now() - Math.random() * 600000),
              threatLevel: ['Low', 'Medium', 'High'][
                Math.floor(Math.random() * 3)
              ],
              battery: Math.round(20 + Math.random() * 80),
              deviceInfo: 'Mobile App v2.1.0',
            },
            {
              id: 'USER-ITUMEL002',
              name: 'Itumeleng Ramokgopa',
              avatar:
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Itumeleng',
              company: 'Emergency Response Unit',
              location: {
                lat: -33.9249 + (Math.random() - 0.5) * 0.1,
                lng: 18.4241 + (Math.random() - 0.5) * 0.1,
                address: 'Cape Town, Western Cape',
              },
              status: Math.random() > 0.5 ? 'active' : 'inactive',
              lastUpdate: new Date(Date.now() - Math.random() * 300000),
              threatLevel: ['Low', 'Medium', 'High'][
                Math.floor(Math.random() * 3)
              ],
              battery: Math.round(30 + Math.random() * 70),
              deviceInfo: 'iOS App v2.0.5',
            },
            {
              id: 'USER-KAGISO003',
              name: 'Kagiso Mokwena',
              avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Kagiso',
              company: 'Crisis Response Team',
              location: {
                lat: -29.8587 + (Math.random() - 0.5) * 0.1,
                lng: 31.0218 + (Math.random() - 0.5) * 0.1,
                address: 'Durban, KwaZulu-Natal',
              },
              status: 'active',
              lastUpdate: new Date(),
              threatLevel: ['Medium', 'High'][Math.floor(Math.random() * 2)],
              battery: Math.round(40 + Math.random() * 60),
              deviceInfo: 'Android App v2.1.2',
            },
            {
              id: 'USER-BUHLE004',
              name: 'Buhle Mthembu',
              avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Buhle',
              company: 'Community Safety Officer',
              location: {
                lat: -25.7479 + (Math.random() - 0.5) * 0.1,
                lng: 28.2293 + (Math.random() - 0.5) * 0.1,
                address: 'Pretoria, Gauteng',
              },
              status: Math.random() > 0.6 ? 'emergency' : 'active',
              lastUpdate: new Date(Date.now() - Math.random() * 180000),
              threatLevel: ['Low', 'Medium'][Math.floor(Math.random() * 2)],
              battery: Math.round(50 + Math.random() * 50),
              deviceInfo: 'Web App v1.9.8',
            },
          ]

          return realUsers
        }

        async loadThreatAssessment() {
          const threatContainer = document.createElement('div')
          threatContainer.className = 'glass-card rounded-xl p-6 mt-6'
          threatContainer.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">
              <i class="fas fa-shield-alt text-red-400 mr-3"></i>
              Threat Assessment Matrix
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass-card rounded-lg p-4 border-l-4 border-red-500">
                <h3 class="text-red-400 font-semibold">High Risk Areas</h3>
                <p class="text-gray-300 text-sm mt-2">3 active threats detected</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>• Johannesburg CBD - Protest activity</div>
                  <div>• Cape Town N2 - Traffic incident</div>
                  <div>• Durban Beachfront - Weather warning</div>
                </div>
              </div>
              <div class="glass-card rounded-lg p-4 border-l-4 border-yellow-500">
                <h3 class="text-yellow-400 font-semibold">Medium Risk Areas</h3>
                <p class="text-gray-300 text-sm mt-2">5 areas under monitoring</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>• Pretoria Central - Crowd gathering</div>
                  <div>• Port Elizabeth Harbor - Security alert</div>
                  <div>• Bloemfontein Mall - Medical emergency</div>
                </div>
              </div>
              <div class="glass-card rounded-lg p-4 border-l-4 border-green-500">
                <h3 class="text-green-400 font-semibold">Safe Zones</h3>
                <p class="text-gray-300 text-sm mt-2">All other areas nominal</p>
                <div class="mt-3 space-y-1 text-xs text-gray-400">
                  <div>• Northern Cape - All clear</div>
                  <div>• Free State Rural - Normal activity</div>
                  <div>• Limpopo Region - Stable</div>
                </div>
              </div>
            </div>
          `

          const mainContainer = document.querySelector('.max-w-7xl')
          if (mainContainer) {
            mainContainer.appendChild(threatContainer)
          }
        }

        async loadActiveMissions() {
          const missionsContainer = document.createElement('div')
          missionsContainer.className = 'glass-card rounded-xl p-6 mt-6'
          missionsContainer.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">
              <i class="fas fa-tasks text-blue-400 mr-3"></i>
              Active Missions Control
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Ongoing Operations</h3>
                <div class="space-y-3">
                  <div class="glass-card rounded-lg p-4 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                      <h4 class="text-white font-semibold">RESCUE-001</h4>
                      <span class="text-xs px-2 py-1 bg-red-600 rounded-full">CRITICAL</span>
                    </div>
                    <p class="text-gray-300 text-sm mt-1">Medical emergency - Johannesburg</p>
                    <p class="text-gray-400 text-xs mt-2">Assigned: Lintshiwe Maluleke</p>
                  </div>
                  <div class="glass-card rounded-lg p-4 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                      <h4 class="text-white font-semibold">ASSIST-002</h4>
                      <span class="text-xs px-2 py-1 bg-yellow-600 rounded-full">MEDIUM</span>
                    </div>
                    <p class="text-gray-300 text-sm mt-1">Traffic assistance - Cape Town</p>
                    <p class="text-gray-400 text-xs mt-2">Assigned: Itumeleng Ramokgopa</p>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Mission Statistics</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-400">12</div>
                    <div class="text-gray-400 text-sm">Completed Today</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-400">5</div>
                    <div class="text-gray-400 text-sm">In Progress</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-400">2</div>
                    <div class="text-gray-400 text-sm">High Priority</div>
                  </div>
                  <div class="glass-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-400">96%</div>
                    <div class="text-gray-400 text-sm">Success Rate</div>
                  </div>
                </div>
              </div>
            </div>
          `

          const mainContainer = document.querySelector('.max-w-7xl')
          if (mainContainer) {
            mainContainer.appendChild(missionsContainer)
          }
        }

        // ===============================
        // LIVE WEATHER SYSTEM METHODS
        // ===============================

        async initializeWeatherSystem() {
          console.log('🌤️ Initializing live weather system...')

          try {
            // Initialize weather map
            this.initializeWeatherMap()

            // Load initial weather data
            await this.loadLiveWeatherData()

            // Start periodic updates
            this.startWeatherUpdates()

            console.log('✅ Live weather system initialized')
          } catch (error) {
            console.error('❌ Error initializing weather system:', error)
            this.showWeatherError()
          }
        }

        initializeWeatherMap() {
          const weatherMapDiv = document.getElementById('weatherMap')
          if (!weatherMapDiv || this.weatherMap) return

          // OpenWeather API key for tile layers (using first working key)
          const openWeatherApiKey = '949678e6f2a5b82bbc459044b85563f5'

          // Initialize map centered on South Africa
          this.weatherMap = L.map('weatherMap', {
            zoomControl: true,
            attributionControl: false,
          }).setView([-28.5, 24.5], 5)

          // Base tile layer
          const baseLayer = L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
              attribution: '© OpenStreetMap contributors',
              maxZoom: 12,
              minZoom: 4,
            }
          ).addTo(this.weatherMap)

          // Weather overlay layers
          this.weatherLayers = {
            Temperature: L.tileLayer(
              `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${openWeatherApiKey}`,
              {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6,
              }
            ),
            Precipitation: L.tileLayer(
              `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${openWeatherApiKey}`,
              {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6,
              }
            ),
            Wind: L.tileLayer(
              `https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${openWeatherApiKey}`,
              {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6,
              }
            ),
            Clouds: L.tileLayer(
              `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${openWeatherApiKey}`,
              {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6,
              }
            ),
          }

          // Add layer control
          L.control
            .layers(
              {
                Map: baseLayer,
              },
              this.weatherLayers,
              {
                position: 'topright',
                collapsed: false,
              }
            )
            .addTo(this.weatherMap)

          // Add weather markers layer
          this.weatherMarkersLayer = L.layerGroup().addTo(this.weatherMap)

          console.log('🗺️ Weather map initialized')
        }

        async loadLiveWeatherData() {
          try {
            const response = await fetch('/api/weather/live/all')

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }

            const result = await response.json()

            if (result.success) {
              this.weatherData = result.data.provinces
              this.updateWeatherDisplay()
              this.updateWeatherMap()
              this.updateWeatherStats()

              // Update last update time
              this.updateLastUpdateTime(result.data.lastUpdate)
              console.log('✅ Weather data loaded successfully')
            } else {
              throw new Error(result.error || 'Failed to fetch weather data')
            }
          } catch (error) {
            console.error('❌ Error loading weather data:', error)
            this.showWeatherError()
            // Use fallback data for demo
            this.loadFallbackWeatherData()
          }
        }

        updateWeatherDisplay() {
          const container = document.getElementById('provincialWeather')
          if (!container) return

          container.innerHTML = ''

          const provinces = Object.entries(this.weatherData)

          // Sort provinces if needed
          if (this.weatherSortBy === 'temperature') {
            provinces.sort((a, b) => b[1].temperature - a[1].temperature)
          } else if (this.weatherSortBy === 'alerts') {
            provinces.sort(
              (a, b) => (b[1].alerts?.length || 0) - (a[1].alerts?.length || 0)
            )
          }

          provinces.forEach(([provinceName, data]) => {
            const card = this.createWeatherCard(provinceName, data)
            container.appendChild(card)
          })
        }

        createWeatherCard(provinceName, data) {
          const card = document.createElement('div')
          const tempClass = this.getTemperatureClass(data.temperature)
          const hasAlerts = data.alerts && data.alerts.length > 0

          card.className = `glass-card rounded-lg p-3 transition-all hover:scale-105 ${tempClass} ${hasAlerts ? 'border-l-4 border-red-500' : ''}`

          const alertBadge = hasAlerts
            ? `<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>`
            : ''

          card.innerHTML = `
            <div class="relative">
              ${alertBadge}
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h4 class="font-semibold text-white text-sm">${provinceName}</h4>
                  <p class="text-xs text-gray-400">${data.city}</p>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold text-white">${data.temperature}°C</div>
                  <div class="text-xs text-gray-300">Feels ${data.feelsLike}°C</div>
                </div>
              </div>
              
              <div class="flex items-center justify-between text-xs text-gray-300">
                <span class="flex items-center">
                  <i class="fas fa-eye mr-1"></i>
                  ${data.condition}
                </span>
                <span class="flex items-center">
                  <i class="fas fa-wind mr-1"></i>
                  ${data.windSpeed} km/h
                </span>
              </div>
              
              <div class="flex items-center justify-between text-xs text-gray-400 mt-1">
                <span>💧 ${data.humidity}%</span>
                <span>📊 ${data.pressure} hPa</span>
              </div>
              
              ${
                hasAlerts
                  ? `
                <div class="mt-2 text-xs">
                  ${data.alerts
                    .map(
                      (alert) => `
                    <div class="bg-red-900/30 rounded px-2 py-1 mb-1">
                      <span class="text-red-300">${alert.type.toUpperCase()}</span>
                    </div>
                  `
                    )
                    .join('')}
                </div>
              `
                  : ''
              }
              
              ${data.isSimulated ? '<div class="text-xs text-yellow-400 mt-1">⚠️ Simulated</div>' : ''}
            </div>
          `

          // Add click handler for details
          card.addEventListener('click', () => {
            this.showProvinceDetails(provinceName, data)
          })

          return card
        }

        updateWeatherMap() {
          if (!this.weatherMap || !this.weatherMarkersLayer) return

          // Clear existing markers
          this.weatherMarkersLayer.clearLayers()

          Object.entries(this.weatherData).forEach(([provinceName, data]) => {
            if (data.coordinates) {
              const marker = this.createWeatherMarker(provinceName, data)
              this.weatherMarkersLayer.addLayer(marker)
            }
          })
        }

        createWeatherMarker(provinceName, data) {
          const tempColor = this.getTemperatureColor(data.temperature)
          const hasAlerts = data.alerts && data.alerts.length > 0

          const icon = L.divIcon({
            className: 'weather-marker',
            html: `
              <div style="
                background: ${tempColor}; 
                width: 32px; 
                height: 32px; 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                border: 2px solid white; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                ${hasAlerts ? 'border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);' : ''}
              ">
                <div style="color: white; font-size: 10px; font-weight: bold; text-align: center;">
                  ${data.temperature}°
                </div>
              </div>
            `,
            iconSize: [32, 32],
            iconAnchor: [16, 16],
          })

          const marker = L.marker(
            [data.coordinates.lat, data.coordinates.lon],
            { icon }
          )

          const popupContent = `
            <div style="min-width: 200px;">
              <h3 style="margin: 0 0 8px 0; color: #1f2937; font-weight: bold;">${provinceName}</h3>
              <div style="margin-bottom: 8px;">
                <strong style="font-size: 18px;">${data.temperature}°C</strong>
                <span style="color: #6b7280; margin-left: 8px;">Feels like ${data.feelsLike}°C</span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                <div><strong>Condition:</strong> ${data.condition}</div>
                <div><strong>Wind:</strong> ${data.windSpeed} km/h</div>
                <div><strong>Humidity:</strong> ${data.humidity}%</div>
                <div><strong>Pressure:</strong> ${data.pressure} hPa</div>
              </div>
              ${
                hasAlerts
                  ? `
                <div style="margin-top: 8px; padding: 8px; background: #fee2e2; border-radius: 4px;">
                  <strong style="color: #dc2626;">⚠️ Weather Alerts:</strong>
                  ${data.alerts.map((alert) => `<div style="font-size: 11px; color: #dc2626;">${alert.message}</div>`).join('')}
                </div>
              `
                  : ''
              }
              <div style="margin-top: 8px; font-size: 10px; color: #9ca3af;">
                Updated: ${new Date(data.lastUpdated).toLocaleTimeString()}
              </div>
            </div>
          `

          marker.bindPopup(popupContent)
          return marker
        }

        updateWeatherStats() {
          if (!this.weatherData) return

          const provinces = Object.values(this.weatherData)
          const totalProvinces = provinces.length
          const provincesWithData = provinces.filter(
            (p) => p.temperature !== undefined
          ).length

          let totalTemp = 0
          let tempCount = 0
          let totalAlerts = 0
          let criticalAlerts = 0

          provinces.forEach((data) => {
            if (data.temperature !== undefined) {
              totalTemp += data.temperature
              tempCount++
            }

            if (data.alerts) {
              totalAlerts += data.alerts.length
              criticalAlerts += data.alerts.filter(
                (a) => a.severity === 'critical'
              ).length
            }
          })

          // Update UI elements
          const avgTemp = tempCount > 0 ? Math.round(totalTemp / tempCount) : 0

          this.updateElement('avgTemperature', `${avgTemp}°C`)
          this.updateElement('weatherAlertCount', totalAlerts)
          this.updateElement(
            'provincesOnline',
            `${provincesWithData}/${totalProvinces}`
          )
          this.updateElement('criticalWeatherAlerts', criticalAlerts)

          // Show/hide alerts section
          const alertsSection = document.getElementById('weatherAlertsSection')
          if (alertsSection) {
            alertsSection.style.display = totalAlerts > 0 ? 'block' : 'none'
          }

          // Update weather status
          this.updateElement(
            'weatherStatus',
            provincesWithData === totalProvinces ? 'Live Data' : 'Partial Data'
          )
        }

        updateLastUpdateTime(lastUpdate) {
          if (lastUpdate) {
            const time = new Date(lastUpdate).toLocaleTimeString()
            this.updateElement('weatherLastUpdate', time)
          }
        }

        updateElement(id, value) {
          const element = document.getElementById(id)
          if (element) {
            element.textContent = value
          }
        }

        getTemperatureClass(temp) {
          if (temp >= 35) return 'border-l-4 border-red-500'
          if (temp >= 30) return 'border-l-4 border-orange-500'
          if (temp >= 25) return 'border-l-4 border-yellow-500'
          if (temp >= 20) return 'border-l-4 border-green-500'
          if (temp >= 15) return 'border-l-4 border-blue-500'
          return 'border-l-4 border-purple-500'
        }

        getTemperatureColor(temp) {
          if (temp >= 35) return '#dc2626' // red-600
          if (temp >= 30) return '#ea580c' // orange-600
          if (temp >= 25) return '#ca8a04' // yellow-600
          if (temp >= 20) return '#16a34a' // green-600
          if (temp >= 15) return '#2563eb' // blue-600
          return '#7c3aed' // purple-600
        }

        startWeatherUpdates() {
          // Refresh weather data every 5 minutes
          setInterval(
            () => {
              this.loadLiveWeatherData()
            },
            5 * 60 * 1000
          )
        }

        updateProvinceWeather(provinceName, data) {
          if (this.weatherData) {
            this.weatherData[provinceName] = data
            this.updateWeatherDisplay()
            this.updateWeatherMap()
            this.updateWeatherStats()
          }
        }

        addWeatherAlert(alertData) {
          const alertsContainer = document.getElementById('weatherAlerts')
          if (!alertsContainer) return

          const alert = document.createElement('div')
          alert.className =
            'bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-3'
          alert.innerHTML = `
            <div class="flex items-start justify-between">
              <div>
                <h4 class="font-semibold text-yellow-300">${alertData.province}</h4>
                <p class="text-sm text-gray-300 mt-1">Weather Alert Issued</p>
              </div>
              <span class="text-xs text-gray-400">${new Date(alertData.timestamp).toLocaleTimeString()}</span>
            </div>
          `

          alertsContainer.insertBefore(alert, alertsContainer.firstChild)

          // Remove old alerts (keep only 5)
          while (alertsContainer.children.length > 5) {
            alertsContainer.removeChild(alertsContainer.lastChild)
          }
        }

        showProvinceDetails(provinceName, data) {
          this.showNotification(
            `Weather details for ${provinceName}: ${data.temperature}°C, ${data.condition}`,
            'info'
          )
        }

        showWeatherError() {
          const container = document.getElementById('provincialWeather')
          if (container) {
            container.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-2"></i>
                <p class="text-sm text-gray-400">Weather data unavailable</p>
                <button id="retryWeatherBtn" class="mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                  Retry
                </button>
              </div>
            `
          }
        }

        contactUser(userId) {
          const userMap = {
            'USER-LINTS001': 'Lintshiwe Maluleke',
            'USER-ITUMEL002': 'Itumeleng Ramokgopa',
            'USER-KAGISO003': 'Kagiso Mokwena',
            'USER-BUHLE004': 'Buhle Mthembu',
          }

          const userName = userMap[userId] || userId
          this.showNotification(
            `Initiating secure contact with ${userName}`,
            'success'
          )
          // Implement real contact functionality
        }

        // ===== MESSAGING SYSTEM =====

        initializeMessaging() {
          this.messages = []
          this.onlineAgents = new Set()

          // Set up message input handlers
          const messageInput = document.getElementById('messageInput')
          const sendButton = document.getElementById('sendMessageBtn')
          const messageCounter = document.getElementById('messageCounter')

          if (messageInput && sendButton) {
            // Handle Enter key to send message
            messageInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault()
                this.sendMessage()
              }
            })

            // Handle send button click
            sendButton.addEventListener('click', () => {
              this.sendMessage()
            })

            // Update character counter
            messageInput.addEventListener('input', () => {
              const count = messageInput.value.length
              messageCounter.textContent = `${count}/500`

              if (count > 450) {
                messageCounter.style.color = '#EF4444'
              } else if (count > 400) {
                messageCounter.style.color = '#F59E0B'
              } else {
                messageCounter.style.color = '#6B7280'
              }
            })
          }

          // Set up socket listeners for messaging
          if (this.socket) {
            this.socket.on('agent-message-broadcast', (data) => {
              this.receiveMessage(data)
            })

            this.socket.on('agent-online', (data) => {
              this.onlineAgents.add(data.agentId)
              this.updateOnlineCount()
              this.addSystemMessage(
                `${data.agentName || data.agentId} joined the channel`
              )
            })

            this.socket.on('agent-offline', (data) => {
              this.onlineAgents.delete(data.agentId)
              this.updateOnlineCount()
              this.addSystemMessage(
                `${data.agentName || data.agentId} left the channel`
              )
            })
          }
        }

        sendMessage() {
          const messageInput = document.getElementById('messageInput')
          if (!messageInput) return

          const message = messageInput.value.trim()
          if (!message) return

          // Create message object
          const messageData = {
            id: Date.now(),
            agentId: this.agentId,
            agentName: this.agentName,
            message: message,
            timestamp: new Date().toISOString(),
            type: 'user',
          }

          // Send via socket
          if (this.socket) {
            this.socket.emit('agent-send-message', messageData)
          }

          // Add to local messages immediately
          this.receiveMessage(messageData)

          // Clear input
          messageInput.value = ''
          document.getElementById('messageCounter').textContent = '0/500'
          document.getElementById('messageCounter').style.color = '#6B7280'
        }

        receiveMessage(data) {
          this.messages.push(data)
          this.displayMessage(data)
          this.scrollToLatestMessage()
        }

        displayMessage(data) {
          const messagesList = document.getElementById('messagesList')
          if (!messagesList) return

          // Remove the "no messages" placeholder if it exists
          const placeholder = messagesList.querySelector('.text-center')
          if (placeholder) {
            placeholder.remove()
          }

          const messageEl = document.createElement('div')
          const isOwnMessage = data.agentId === this.agentId
          const time = new Date(data.timestamp).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
          })

          if (data.type === 'system') {
            messageEl.className = 'text-center text-xs text-gray-400 py-1'
            messageEl.innerHTML = `<i class="fas fa-info-circle mr-1"></i>${data.message}`
          } else {
            messageEl.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3`
            messageEl.innerHTML = `
              <div class="max-w-xs lg:max-w-md">
                <div class="${isOwnMessage ? 'bg-green-600' : 'bg-gray-700'} rounded-lg px-4 py-2 text-white text-sm">
                  <div class="font-medium text-xs ${isOwnMessage ? 'text-green-200' : 'text-blue-300'} mb-1">
                    ${isOwnMessage ? 'You' : data.agentName || data.agentId}
                  </div>
                  <div>${data.message}</div>
                  <div class="text-xs opacity-70 mt-1">${time}</div>
                </div>
              </div>
            `
          }

          messagesList.appendChild(messageEl)

          // Limit to last 100 messages to prevent memory issues
          const messages = messagesList.children
          if (messages.length > 100) {
            messagesList.removeChild(messages[0])
          }
        }

        addSystemMessage(message) {
          const systemMessage = {
            id: Date.now(),
            message: message,
            timestamp: new Date().toISOString(),
            type: 'system',
          }
          this.receiveMessage(systemMessage)
        }

        updateOnlineCount() {
          const countEl = document.getElementById('onlineAgentsCount')
          if (countEl) {
            countEl.textContent = this.onlineAgents.size
          }
        }

        scrollToLatestMessage() {
          const container = document.getElementById('messagesContainer')
          if (container) {
            container.scrollTop = container.scrollHeight
          }
        }

        // ============ USER COMMUNICATION METHODS ============

        initializeUserCommunication() {
          // Initialize user tracking variables
          this.activeUsers = new Map()
          this.userMessages = []
          this.userAlerts = []
          this.selectedUserId = null

          // Setup event listeners for user communication
          this.setupUserCommunicationListeners()

          // Initialize UI elements
          this.updateUserCounts()
        }

        setupUserCommunicationListeners() {
          // Quick response buttons
          document.querySelectorAll('.quick-response-btn').forEach((btn) => {
            btn.addEventListener('click', (e) => {
              const message = e.target.dataset.message
              if (this.selectedUserId && message) {
                this.sendMessageToUser(this.selectedUserId, message)
              } else {
                this.showNotification('Select a user first', 'warning')
              }
            })
          })

          // User message input
          const userResponseInput = document.getElementById('userResponseInput')
          const sendUserMessageBtn =
            document.getElementById('sendUserMessageBtn')

          if (userResponseInput && sendUserMessageBtn) {
            sendUserMessageBtn.addEventListener('click', () => {
              this.sendUserMessage()
            })

            userResponseInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                this.sendUserMessage()
              }
            })
          }
        }

        addUserEmergencyAlert(alertData) {
          console.log('🚨 Adding user emergency alert:', alertData)

          const container = document.getElementById('userEmergencyAlerts')
          if (!container) return

          // Clear placeholder if present
          const placeholder = container.querySelector('.text-center')
          if (placeholder) {
            placeholder.remove()
          }

          // Create enhanced alert element
          const alertEl = document.createElement('div')
          alertEl.className =
            'bg-red-900/50 border border-red-700/30 rounded-lg p-4 hover:bg-red-900/70 transition-all duration-300 cursor-pointer emergency-glow'
          alertEl.dataset.alertId = alertData.alertId
          alertEl.dataset.userId = alertData.userId

          const timeAgo = this.formatTimeAgo(new Date(alertData.timestamp))
          const locationText = alertData.location
            ? `${alertData.location.latitude.toFixed(6)}, ${alertData.location.longitude.toFixed(6)}`
            : 'Location unknown'

          // Enhanced user information display
          const userName =
            alertData.userName ||
            alertData.userInfo?.name ||
            alertData.userId ||
            'Unknown User'
          const userPhone =
            alertData.userPhone || alertData.userInfo?.phone || 'Not provided'
          const userEmail = alertData.userInfo?.email || 'Not provided'
          const emergencyContact = alertData.emergencyContact || userPhone

          alertEl.innerHTML = `
            <div class="emergency-alert-header mb-3">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-2">
                  <i class="fas fa-exclamation-triangle text-red-400 text-lg animate-pulse"></i>
                  <span class="font-bold text-red-300 text-lg">${alertData.type.toUpperCase()} EMERGENCY</span>
                  <span class="text-xs bg-red-800/70 px-2 py-1 rounded font-semibold">${alertData.alertPriority || alertData.severity}</span>
                </div>
                <span class="text-xs text-gray-300 bg-gray-800/50 px-2 py-1 rounded">${alertData.alertId}</span>
              </div>
            </div>
            
            <div class="emergency-alert-body">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                <div class="user-info bg-gray-800/50 p-3 rounded">
                  <h4 class="text-sm font-semibold text-white mb-2"><i class="fas fa-user mr-2"></i>User Information</h4>
                  <div class="space-y-1 text-xs">
                    <div><span class="text-gray-400">Name:</span> <span class="text-white">${userName}</span></div>
                    <div><span class="text-gray-400">ID:</span> <span class="text-white">${alertData.userId}</span></div>
                    <div><span class="text-gray-400">Phone:</span> <span class="text-green-400">${userPhone}</span></div>
                    <div><span class="text-gray-400">Email:</span> <span class="text-blue-400">${userEmail}</span></div>
                  </div>
                </div>
                
                <div class="location-info bg-gray-800/50 p-3 rounded">
                  <h4 class="text-sm font-semibold text-white mb-2"><i class="fas fa-map-marker-alt mr-2"></i>Location Details</h4>
                  <div class="space-y-1 text-xs">
                    <div><span class="text-gray-400">Coordinates:</span> <span class="text-yellow-400">${locationText}</span></div>
                    <div><span class="text-gray-400">Time:</span> <span class="text-white">${timeAgo}</span></div>
                    <div><span class="text-gray-400">Status:</span> <span class="text-red-400">ACTIVE EMERGENCY</span></div>
                  </div>
                </div>
              </div>
              
              <div class="emergency-description bg-gray-800/30 p-3 rounded mb-3">
                <h4 class="text-sm font-semibold text-white mb-1"><i class="fas fa-info-circle mr-2"></i>Emergency Details</h4>
                <p class="text-sm text-gray-200">${alertData.description}</p>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 text-xs text-gray-400">
                  <span><i class="fas fa-clock mr-1"></i>Received: ${timeAgo}</span>
                  <span><i class="fas fa-signal mr-1"></i>Priority: ${alertData.alertPriority || 'HIGH'}</span>
                </div>
                
                <div class="flex space-x-2">
                  <button class="assign-alert-btn px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors" 
                          data-alert-id="${alertData.alertId}" 
                          data-user-id="${alertData.userId}"
                          data-user-name="${userName}"
                          data-user-phone="${userPhone}">
                    <i class="fas fa-hand-paper mr-2"></i>Assign to Me
                  </button>
                  <button class="message-user-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors" 
                          data-user-id="${alertData.userId}"
                          data-user-name="${userName}">
                    <i class="fas fa-comment mr-2"></i>Message User
                  </button>
                  <button class="location-btn px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-sm font-medium transition-colors" 
                          data-user-id="${alertData.userId}"
                          data-location='${JSON.stringify(alertData.location)}'>
                    <i class="fas fa-map-marker-alt mr-2"></i>Get Location
                  </button>
                </div>
              </div>
            </div>
          `

          // Add event listeners for buttons
          const assignBtn = alertEl.querySelector('.assign-alert-btn')
          const messageBtn = alertEl.querySelector('.message-user-btn')
          const locationBtn = alertEl.querySelector('.location-btn')

          if (assignBtn) {
            assignBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              this.assignAlertToSelf(alertData)
            })
          }

          if (messageBtn) {
            messageBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              this.selectUser(alertData.userId)
            })
          }

          if (locationBtn) {
            locationBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              this.requestUserLocation(alertData.userId)
            })
          }

          // Click to select user
          alertEl.addEventListener('click', () => {
            this.selectUser(alertData.userId)
          })

          // Add to container at the top (most recent first)
          container.insertBefore(alertEl, container.firstChild)
          this.userAlerts.push(alertData)

          // Play alert sound and show notification
          this.playThreatAlarm()
          this.showNotification(
            `🚨 NEW EMERGENCY: ${alertData.userName || alertData.userId} - ${alertData.type.toUpperCase()}`,
            'emergency'
          )

          console.log(
            `✅ Emergency alert added to dashboard for user ${alertData.userId}`
          )
          this.updateUserCounts()
        }

        addUserMessage(messageData) {
          console.log('Adding user message:', messageData)

          const container = document.getElementById('userMessages')
          if (!container) return

          // Clear placeholder if present
          const placeholder = container.querySelector('.text-center')
          if (placeholder) {
            placeholder.remove()
          }

          const messageEl = document.createElement('div')
          messageEl.className =
            'bg-blue-900/30 border border-blue-700/20 rounded-lg p-3 hover:bg-blue-900/50 transition-colors cursor-pointer'
          messageEl.dataset.userId = messageData.userId

          const timeAgo = this.formatTimeAgo(new Date(messageData.timestamp))

          messageEl.innerHTML = `
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                  <i class="fas fa-user text-blue-400"></i>
                  <span class="font-semibold text-blue-300">${messageData.userId}</span>
                  <span class="text-xs text-gray-400">${timeAgo}</span>
                </div>
                <p class="text-sm text-gray-200">${messageData.message}</p>
              </div>
              <button class="reply-btn px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs" 
                      data-user-id="${messageData.userId}">
                <i class="fas fa-reply mr-1"></i>Reply
              </button>
            </div>
          `

          // Add event listeners
          const replyBtn = messageEl.querySelector('.reply-btn')
          if (replyBtn) {
            replyBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              this.selectUser(messageData.userId)
            })
          }

          messageEl.addEventListener('click', () => {
            this.selectUser(messageData.userId)
          })

          container.appendChild(messageEl)
          this.userMessages.push(messageData)
          this.updateUserCounts()
        }

        selectUser(userId) {
          this.selectedUserId = userId
          document.getElementById('selectedUserId').textContent = userId
          document.getElementById('selectedUserStatus').textContent =
            'Selected for communication'

          // Highlight selected user in messages and alerts
          document.querySelectorAll('[data-user-id]').forEach((el) => {
            if (el.dataset.userId === userId) {
              el.classList.add('ring-2', 'ring-purple-500')
            } else {
              el.classList.remove('ring-2', 'ring-purple-500')
            }
          })

          this.showNotification(`Selected user: ${userId}`, 'info')
        }

        sendUserMessage() {
          const input = document.getElementById('userResponseInput')
          const message = input.value.trim()

          if (!message) return

          if (!this.selectedUserId) {
            this.showNotification('Please select a user first', 'warning')
            return
          }

          this.sendMessageToUser(this.selectedUserId, message)
          input.value = ''
        }

        sendMessageToUser(userId, message) {
          if (!this.socket || !userId || !message) return

          const messageData = {
            agentId: this.agentId,
            agentName: this.agentName,
            userId: userId,
            message: message,
            timestamp: new Date().toISOString(),
          }

          console.log('Sending message to user:', messageData)
          this.socket.emit('agent-message-to-user', messageData)
        }

        assignAlertToSelf(alertData) {
          if (!this.socket || !alertData) return

          // Calculate ETA based on distance if available
          let estimatedArrival = '5-10 minutes'
          if (alertData.location && this.currentLocation) {
            const distance = this.calculateDistance(
              this.currentLocation.lat,
              this.currentLocation.lng,
              alertData.location.latitude,
              alertData.location.longitude
            )
            const eta = Math.round((distance / 30) * 60) // Assuming 30km/h average speed
            estimatedArrival = `${eta} minutes`
          }

          const assignmentData = {
            agentId: this.agentId,
            agentName: this.agentName,
            alertId: alertData.alertId,
            userId: alertData.userId,
            estimatedArrival: estimatedArrival,
            dbId: alertData.dbId,
            location: this.currentLocation,
            distance:
              alertData.location && this.currentLocation
                ? this.calculateDistance(
                    this.currentLocation.lat,
                    this.currentLocation.lng,
                    alertData.location.latitude,
                    alertData.location.longitude
                  ).toFixed(2) + ' km'
                : 'Calculating...',
          }

          console.log('🚨 Assigning emergency alert to self:', assignmentData)
          this.socket.emit('agent-assign-to-alert', assignmentData)

          // Show confirmation
          this.showNotification(
            `✅ You have been assigned to assist ${alertData.userName || alertData.userId}`,
            'success'
          )

          // Remove from available alerts and add to missions
          this.removeUserAlert(alertData.alertId)
          this.addActiveMission({
            id: alertData.alertId,
            userId: alertData.userId,
            userName: alertData.userName || alertData.userId,
            userPhone: alertData.userPhone,
            emergency_type: alertData.type,
            description: alertData.description,
            location: alertData.location,
            status: 'in-progress',
            assigned_agent: {
              id: this.agentId,
              name: this.agentName,
            },
            assignedAt: new Date().toISOString(),
            estimatedArrival: estimatedArrival,
          })

          // Automatically request user's real-time location
          setTimeout(() => {
            this.requestUserLocation(alertData.userId)
          }, 1000)
        }

        requestUserLocation(userId) {
          if (!this.socket) return

          console.log(`📍 Requesting location from user ${userId}`)

          this.socket.emit('agent-control-request', {
            agentId: this.agentId,
            agentName: this.agentName,
            userId: userId,
            controlType: 'realTimeLocation',
            message:
              'Agent is requesting your current location to provide better assistance',
          })

          // Also send location request
          this.socket.emit('location-request', {
            agentId: this.agentId,
            agentName: this.agentName,
            userId: userId,
          })

          this.showNotification(
            `📍 Location request sent to user ${userId}`,
            'info'
          )
        }

        // Enhanced location calculation
        calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371 // Earth's radius in km
          const dLat = ((lat2 - lat1) * Math.PI) / 180
          const dLon = ((lon2 - lon1) * Math.PI) / 180
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) *
              Math.cos((lat2 * Math.PI) / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2)
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
          return R * c
        }

        removeUserAlert(alertId) {
          const alertEl = document.querySelector(`[data-alert-id="${alertId}"]`)
          if (alertEl) {
            alertEl.remove()
          }

          this.userAlerts = this.userAlerts.filter(
            (alert) => alert.alertId !== alertId
          )
          this.updateUserCounts()

          // Check if we need to show placeholder
          const container = document.getElementById('userEmergencyAlerts')
          if (container && container.children.length === 0) {
            container.innerHTML = `
              <div class="text-center py-8 text-gray-400">
                <i class="fas fa-shield-alt text-4xl mb-3"></i>
                <p>No emergency alerts</p>
                <p class="text-xs">Monitoring for user emergencies...</p>
              </div>
            `
          }
        }

        updateUserLocation(data) {
          console.log('Updating user location:', data)
          // Store user location for tracking
          if (this.activeUsers.has(data.userId)) {
            const user = this.activeUsers.get(data.userId)
            user.location = data.location
            this.activeUsers.set(data.userId, user)
          } else {
            this.activeUsers.set(data.userId, {
              userId: data.userId,
              location: data.location,
              lastSeen: new Date(),
            })
          }
        }

        addActiveUser(userData) {
          this.activeUsers.set(userData.userId, {
            ...userData,
            lastSeen: new Date(),
          })
          this.updateUserCounts()
        }

        updateUserCounts() {
          // Update active users count
          const activeUsersCount = document.getElementById('activeUsersCount')
          if (activeUsersCount) {
            activeUsersCount.textContent = this.activeUsers.size
          }

          // Update alerts count
          const userAlertsCount = document.getElementById('userAlertsCount')
          if (userAlertsCount) {
            userAlertsCount.textContent = this.userAlerts.length
          }

          // Update unread messages count
          const unreadMessagesCount = document.getElementById(
            'unreadMessagesCount'
          )
          if (unreadMessagesCount) {
            unreadMessagesCount.textContent = this.userMessages.length
          }
        }

        formatTimeAgo(date) {
          const now = new Date()
          const diff = now - date
          const minutes = Math.floor(diff / 60000)
          const hours = Math.floor(minutes / 60)
          const days = Math.floor(hours / 24)

          if (days > 0) return `${days}d ago`
          if (hours > 0) return `${hours}h ago`
          if (minutes > 0) return `${minutes}m ago`
          return 'Just now'
        }

        // ============ END USER COMMUNICATION METHODS ============
      } // Initialize the advanced dashboard

      // Global weather functions for UI buttons
      let dashboard = null

      window.refreshWeatherData = async function () {
        if (dashboard) {
          await dashboard.loadLiveWeatherData()
          dashboard.showNotification('Weather data refreshed', 'success')
        }
      }

      window.toggleWeatherLayers = function () {
        console.log('toggleWeatherLayers called')
        console.log('dashboard:', dashboard)
        console.log('dashboard.weatherMap:', dashboard?.weatherMap)
        console.log('dashboard.weatherLayers:', dashboard?.weatherLayers)

        if (dashboard && dashboard.weatherMap && dashboard.weatherLayers) {
          dashboard.weatherLayersVisible = !dashboard.weatherLayersVisible
          console.log(
            'weatherLayersVisible now:',
            dashboard.weatherLayersVisible
          )

          // Toggle all weather layers on the map
          Object.values(dashboard.weatherLayers).forEach((layer, index) => {
            console.log(`Processing layer ${index}:`, layer)
            if (dashboard.weatherLayersVisible) {
              // Add layer to map if not already added
              if (!dashboard.weatherMap.hasLayer(layer)) {
                console.log(`Adding layer ${index} to map`)
                layer.addTo(dashboard.weatherMap)
              } else {
                console.log(`Layer ${index} already on map`)
              }
            } else {
              // Remove layer from map
              if (dashboard.weatherMap.hasLayer(layer)) {
                console.log(`Removing layer ${index} from map`)
                dashboard.weatherMap.removeLayer(layer)
              } else {
                console.log(`Layer ${index} not on map`)
              }
            }
          })

          dashboard.showNotification(
            `Weather layers ${dashboard.weatherLayersVisible ? 'enabled' : 'disabled'}`,
            'info'
          )
        } else {
          console.log('Missing required objects for weather layer toggle')
          console.log('dashboard exists:', !!dashboard)
          console.log('weatherMap exists:', !!dashboard?.weatherMap)
          console.log('weatherLayers exists:', !!dashboard?.weatherLayers)
        }
      }

      window.toggleMapFullscreen = function () {
        const mapContainer = document.getElementById('weatherMap')
        if (mapContainer) {
          if (document.fullscreenElement) {
            document.exitFullscreen()
          } else {
            mapContainer.requestFullscreen()
          }
        }
      }

      window.toggleWeatherSort = function () {
        if (dashboard) {
          const sortOptions = ['name', 'temperature', 'alerts']
          const currentIndex = sortOptions.indexOf(dashboard.weatherSortBy)
          dashboard.weatherSortBy =
            sortOptions[(currentIndex + 1) % sortOptions.length]
          dashboard.updateWeatherDisplay()
          dashboard.showNotification(
            `Sorted by ${dashboard.weatherSortBy}`,
            'info'
          )
        }
      }

      // Add error handling and debugging for initialization
      try {
        console.log('🚀 Initializing Agent Dashboard...')
        dashboard = new AdvancedAgentDashboard()

        // Setup global event listeners
        setTimeout(() => {
          const refreshBtn = document.getElementById('refreshWeatherBtn')
          if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshWeatherData)
          }

          const toggleLayersBtn = document.getElementById(
            'toggleWeatherLayersBtn'
          )
          if (toggleLayersBtn) {
            toggleLayersBtn.addEventListener('click', toggleWeatherLayers)
          }

          // Handle retry button dynamically when it's created
          document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'retryWeatherBtn') {
              dashboard.initializeWeatherSystem()
            }
          })
        }, 1000)

        console.log('✅ Agent Dashboard initialized successfully')
      } catch (error) {
        console.error('❌ Failed to initialize Agent Dashboard:', error)
        console.error('Stack trace:', error.stack)
      }
    </script>
  </body>
</html>
